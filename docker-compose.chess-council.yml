# Docker Compose for Chess Council Local Development
# 10-Dimensional Chess Council - Adversarial AI Research System
version: '3.8'

networks:
  chess-council-network:
    driver: bridge

volumes:
  postgres_chess_data:
  qdrant_chess_data:
  ollama_models:
  agent_workspace:
  bibliography_cache:

services:
  # ═══════════════════════════════════════════════════════════
  # CORE INFRASTRUCTURE
  # ═══════════════════════════════════════════════════════════
  
  # PostgreSQL for game logs and agent state
  postgres-chess:
    image: postgres:16-alpine
    container_name: chess-council-postgres
    environment:
      POSTGRES_DB: chess_council
      POSTGRES_USER: chess_council
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-chess_dev_password}
    volumes:
      - postgres_chess_data:/var/lib/postgresql/data
      - ./scripts/init-chess-db.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5433:5432"
    networks:
      - chess-council-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U chess_council"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  # Qdrant vector database for bibliography embeddings
  qdrant-chess:
    image: qdrant/qdrant:latest
    container_name: chess-council-qdrant
    volumes:
      - qdrant_chess_data:/qdrant/storage
    ports:
      - "6334:6333"
      - "6335:6334"
    networks:
      - chess-council-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  # Redis for agent communication and game state
  redis-chess:
    image: redis:7-alpine
    container_name: chess-council-redis
    ports:
      - "6380:6379"
    networks:
      - chess-council-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  # Ollama for local LLM inference
  ollama-chess:
    image: ollama/ollama:latest
    container_name: chess-council-ollama
    volumes:
      - ollama_models:/root/.ollama
    ports:
      - "11435:11434"
    networks:
      - chess-council-network
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 5
  
  # ═══════════════════════════════════════════════════════════
  # GAME ORCHESTRATION
  # ═══════════════════════════════════════════════════════════
  
  # Game Orchestrator - manages chess matches
  game-orchestrator:
    build:
      context: .
      dockerfile: Dockerfile.orchestrator
    container_name: chess-council-orchestrator
    environment:
      POSTGRES_DSN: postgresql://chess_council:${POSTGRES_PASSWORD:-chess_dev_password}@postgres-chess:5432/chess_council
      QDRANT_URL: http://qdrant-chess:6333
      REDIS_URL: redis://redis-chess:6379
      STOCKFISH_SERVICE: http://stockfish-referee:8081
      OLLAMA_HOST: http://ollama-chess:11434
      LOG_LEVEL: INFO
    ports:
      - "8090:8080"
      - "9001:9000"
    networks:
      - chess-council-network
    depends_on:
      postgres-chess:
        condition: service_healthy
      qdrant-chess:
        condition: service_healthy
      redis-chess:
        condition: service_healthy
    restart: unless-stopped
  
  # Stockfish Referee - evaluates game moves
  stockfish-referee:
    build:
      context: .
      dockerfile: Dockerfile.stockfish
    container_name: chess-council-stockfish
    environment:
      STOCKFISH_THREADS: "4"
      STOCKFISH_HASH_MB: "512"
      STOCKFISH_DEPTH: "15"
    ports:
      - "8091:8081"
    networks:
      - chess-council-network
    restart: unless-stopped
  
  # ═══════════════════════════════════════════════════════════
  # SAMPLE AGENTS (4 agents for local dev)
  # ═══════════════════════════════════════════════════════════
  
  # Agent 0 - Empirical Data Layer (Board 0, Position 0)
  agent-0:
    build:
      context: .
      dockerfile: Dockerfile.chess-agent
    container_name: chess-agent-0
    environment:
      BOARD_LAYER: "0"
      AGENT_ID: "agent-0"
      GROK_API_KEY: ${GROK_API_KEY:-}
      SERPAPI_KEY: ${SERPAPI_KEY:-}
      POSTGRES_DSN: postgresql://chess_council:${POSTGRES_PASSWORD:-chess_dev_password}@postgres-chess:5432/chess_council
      QDRANT_URL: http://qdrant-chess:6333
      OLLAMA_HOST: http://ollama-chess:11434
      PRIMARY_MODEL: "qwen2.5:7b"  # Smaller model for dev
    volumes:
      - agent_workspace:/workspace
      - bibliography_cache:/cache
    ports:
      - "8100:8080"
      - "5901:5900"
    networks:
      - chess-council-network
    depends_on:
      - postgres-chess
      - qdrant-chess
      - ollama-chess
    restart: unless-stopped
  
  # Agent 1 - Analysis Layer (Board 2, Position 0)
  agent-1:
    build:
      context: .
      dockerfile: Dockerfile.chess-agent
    container_name: chess-agent-1
    environment:
      BOARD_LAYER: "2"
      AGENT_ID: "agent-1"
      GROK_API_KEY: ${GROK_API_KEY:-}
      SERPAPI_KEY: ${SERPAPI_KEY:-}
      POSTGRES_DSN: postgresql://chess_council:${POSTGRES_PASSWORD:-chess_dev_password}@postgres-chess:5432/chess_council
      QDRANT_URL: http://qdrant-chess:6333
      OLLAMA_HOST: http://ollama-chess:11434
      PRIMARY_MODEL: "qwen2.5:7b"
    volumes:
      - agent_workspace:/workspace
      - bibliography_cache:/cache
    ports:
      - "8101:8080"
      - "5902:5900"
    networks:
      - chess-council-network
    depends_on:
      - postgres-chess
      - qdrant-chess
      - ollama-chess
    restart: unless-stopped
  
  # Agent 2 - Synthesis Layer (Board 3, Position 0)
  agent-2:
    build:
      context: .
      dockerfile: Dockerfile.chess-agent
    container_name: chess-agent-2
    environment:
      BOARD_LAYER: "3"
      AGENT_ID: "agent-2"
      GROK_API_KEY: ${GROK_API_KEY:-}
      SERPAPI_KEY: ${SERPAPI_KEY:-}
      POSTGRES_DSN: postgresql://chess_council:${POSTGRES_PASSWORD:-chess_dev_password}@postgres-chess:5432/chess_council
      QDRANT_URL: http://qdrant-chess:6333
      OLLAMA_HOST: http://ollama-chess:11434
      PRIMARY_MODEL: "qwen2.5:7b"
    volumes:
      - agent_workspace:/workspace
      - bibliography_cache:/cache
    ports:
      - "8102:8080"
      - "5903:5900"
    networks:
      - chess-council-network
    depends_on:
      - postgres-chess
      - qdrant-chess
      - ollama-chess
    restart: unless-stopped
  
  # Agent 3 - Publication Layer (Board 9, Position 0)
  agent-3:
    build:
      context: .
      dockerfile: Dockerfile.chess-agent
    container_name: chess-agent-3
    environment:
      BOARD_LAYER: "9"
      AGENT_ID: "agent-3"
      GROK_API_KEY: ${GROK_API_KEY:-}
      SERPAPI_KEY: ${SERPAPI_KEY:-}
      POSTGRES_DSN: postgresql://chess_council:${POSTGRES_PASSWORD:-chess_dev_password}@postgres-chess:5432/chess_council
      QDRANT_URL: http://qdrant-chess:6333
      OLLAMA_HOST: http://ollama-chess:11434
      PRIMARY_MODEL: "qwen2.5:7b"
    volumes:
      - agent_workspace:/workspace
      - bibliography_cache:/cache
    ports:
      - "8103:8080"
      - "5904:5900"
    networks:
      - chess-council-network
    depends_on:
      - postgres-chess
      - qdrant-chess
      - ollama-chess
    restart: unless-stopped
  
  # ═══════════════════════════════════════════════════════════
  # MONITORING & OBSERVABILITY
  # ═══════════════════════════════════════════════════════════
  
  # Prometheus for metrics
  prometheus-chess:
    image: prom/prometheus:latest
    container_name: chess-council-prometheus
    volumes:
      - ./monitoring/prometheus-chess.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9091:9090"
    networks:
      - chess-council-network
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
  
  # Grafana for visualization
  grafana-chess:
    image: grafana/grafana:latest
    container_name: chess-council-grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
    ports:
      - "3001:3000"
    networks:
      - chess-council-network
    depends_on:
      - prometheus-chess
