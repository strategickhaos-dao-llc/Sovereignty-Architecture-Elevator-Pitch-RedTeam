# Agent Collaboration Infrastructure Configuration
# Strategickhaos Sovereign Swarm - Multi-Agent Coordination
# Version: 1.0
# Date: 2025-11-23

version: "1.0"
date: "2025-11-23"
project: "Agent Collaboration Infrastructure"

# =============================================================================
# OVERVIEW
# =============================================================================
overview:
  description: |
    Configuration for enabling collaboration between inline agents and the 
    sovereign infrastructure environment (Docker Desktop, Kubernetes Swarm, 
    Kali Linux, and Parrot OS).
  
  objectives:
    - "Secure VPN-based communication between agents and infrastructure"
    - "Authenticated and authorized API access for agents"
    - "Real-time monitoring and logging of agent activities"
    - "Collaborative workflows with shared tools and resources"
    - "Comprehensive security and RBAC implementation"

# =============================================================================
# 1. NETWORK CONFIGURATION
# =============================================================================
network:
  vpn:
    type: "WireGuard"
    description: "Secure VPN for agent-to-infrastructure communication"
    
    configuration:
      server:
        endpoint: "vpn.strategickhaos.internal"
        port: 51820
        subnet: "10.200.0.0/24"
        interface: "wg0"
      
      peers:
        - name: "kali-agent-1"
          public_key: "[KALI_PUBLIC_KEY]"
          allowed_ips: "10.200.0.10/32"
          persistent_keepalive: 25
        
        - name: "parrot-agent-1"
          public_key: "[PARROT_PUBLIC_KEY]"
          allowed_ips: "10.200.0.11/32"
          persistent_keepalive: 25
        
        - name: "inline-agent-pool"
          public_key: "[AGENT_POOL_PUBLIC_KEY]"
          allowed_ips: "10.200.0.20-10.200.0.50"
          persistent_keepalive: 25
    
    setup_script: |
      #!/bin/bash
      # WireGuard VPN Setup Script
      
      # Install WireGuard
      sudo apt update && sudo apt install -y wireguard
      
      # Generate keys if not exists
      if [ ! -f /etc/wireguard/privatekey ]; then
        wg genkey | sudo tee /etc/wireguard/privatekey | wg pubkey | sudo tee /etc/wireguard/publickey
      fi
      
      # Configure WireGuard interface
      sudo cat > /etc/wireguard/wg0.conf <<EOF
      [Interface]
      PrivateKey = $(sudo cat /etc/wireguard/privatekey)
      Address = 10.200.0.1/24
      ListenPort = 51820
      PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
      PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
      
      # Add peer configurations here
      EOF
      
      # Enable IP forwarding
      echo "net.ipv4.ip_forward = 1" | sudo tee -a /etc/sysctl.conf
      sudo sysctl -p
      
      # Start WireGuard
      sudo wg-quick up wg0
      sudo systemctl enable wg-quick@wg0
  
  port_forwarding:
    description: "Expose services securely for agent access"
    
    docker_services:
      - service: "api-gateway"
        internal_port: 8080
        external_port: 8080
        protocol: "TCP"
        expose_command: "docker run -d -p 8080:8080 strategickhaos/api-gateway:latest"
        access_control: "VPN-only"
      
      - service: "metrics-endpoint"
        internal_port: 9090
        external_port: 9090
        protocol: "TCP"
        expose_command: "docker run -d -p 9090:9090 prom/prometheus:latest"
        access_control: "VPN-only"
      
      - service: "log-aggregator"
        internal_port: 3100
        external_port: 3100
        protocol: "TCP"
        expose_command: "docker run -d -p 3100:3100 grafana/loki:latest"
        access_control: "VPN-only"
    
    kubernetes_services:
      - service: "agent-api"
        type: "NodePort"
        port: 80
        node_port: 30001
        selector:
          app: "agent-api"
        manifest: |
          apiVersion: v1
          kind: Service
          metadata:
            name: agent-api
            namespace: strategickhaos
          spec:
            type: NodePort
            ports:
              - port: 80
                nodePort: 30001
                targetPort: 8080
            selector:
              app: agent-api
      
      - service: "vector-db"
        type: "NodePort"
        port: 6333
        node_port: 30002
        selector:
          app: "qdrant"
        manifest: |
          apiVersion: v1
          kind: Service
          metadata:
            name: vector-db
            namespace: strategickhaos
          spec:
            type: NodePort
            ports:
              - port: 6333
                nodePort: 30002
                targetPort: 6333
            selector:
              app: qdrant
      
      - service: "redis-cache"
        type: "NodePort"
        port: 6379
        node_port: 30003
        selector:
          app: "redis"
        manifest: |
          apiVersion: v1
          kind: Service
          metadata:
            name: redis-cache
            namespace: strategickhaos
          spec:
            type: NodePort
            ports:
              - port: 6379
                nodePort: 30003
                targetPort: 6379
            selector:
              app: redis
  
  firewall_rules:
    iptables:
      - rule: "Allow VPN subnet to Kubernetes API"
        command: "iptables -A INPUT -s 10.200.0.0/24 -p tcp --dport 6443 -j ACCEPT"
      
      - rule: "Allow VPN subnet to NodePort range"
        command: "iptables -A INPUT -s 10.200.0.0/24 -p tcp --dport 30000:32767 -j ACCEPT"
      
      - rule: "Block external access to NodePorts"
        command: "iptables -A INPUT ! -s 10.200.0.0/24 -p tcp --dport 30000:32767 -j DROP"
      
      - rule: "Allow established connections"
        command: "iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT"
    
    save_command: "sudo iptables-save > /etc/iptables/rules.v4"

# =============================================================================
# 2. ENVIRONMENT SETUP
# =============================================================================
environment_setup:
  kali_linux:
    description: "Kali Linux terminal configuration for agent interaction"
    
    required_tools:
      - name: "kubectl"
        version: "latest"
        install_command: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          kubectl version --client
      
      - name: "docker"
        version: "latest"
        install_command: |
          sudo apt update
          sudo apt install -y docker.io
          sudo systemctl enable docker --now
          sudo usermod -aG docker $USER
      
      - name: "curl"
        version: "latest"
        install_command: "sudo apt install -y curl"
      
      - name: "jq"
        version: "latest"
        install_command: "sudo apt install -y jq"
        description: "JSON parsing for API responses"
      
      - name: "helm"
        version: "3.x"
        install_command: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      
      - name: "wireguard"
        version: "latest"
        install_command: "sudo apt install -y wireguard wireguard-tools"
    
    configuration_files:
      kubeconfig:
        path: "~/.kube/config"
        description: "Kubernetes cluster configuration"
        setup: |
          mkdir -p ~/.kube
          # Copy kubeconfig from cluster or use kubectl config commands
          kubectl config set-cluster strategickhaos --server=https://k8s.strategickhaos.internal:6443
          kubectl config set-credentials agent --token=[AGENT_TOKEN]
          kubectl config set-context strategickhaos --cluster=strategickhaos --user=agent
          kubectl config use-context strategickhaos
      
      docker_config:
        path: "~/.docker/config.json"
        description: "Docker registry authentication"
        setup: |
          docker login registry.strategickhaos.internal
      
      vpn_config:
        path: "/etc/wireguard/wg0.conf"
        description: "WireGuard VPN client configuration"
        template: |
          [Interface]
          PrivateKey = [CLIENT_PRIVATE_KEY]
          Address = 10.200.0.10/32
          DNS = 10.200.0.1
          
          [Peer]
          PublicKey = [SERVER_PUBLIC_KEY]
          Endpoint = vpn.strategickhaos.internal:51820
          AllowedIPs = 10.200.0.0/24
          PersistentKeepalive = 25
  
  parrot_os:
    description: "Parrot OS terminal configuration for security operations"
    
    required_tools:
      # Same as Kali Linux plus additional security tools
      - name: "metasploit-framework"
        version: "latest"
        install_command: "sudo apt install -y metasploit-framework"
      
      - name: "nmap"
        version: "latest"
        install_command: "sudo apt install -y nmap"
      
      - name: "wireshark"
        version: "latest"
        install_command: "sudo apt install -y wireshark"
      
      - name: "ansible"
        version: "latest"
        install_command: "sudo apt install -y ansible"
    
    security_considerations:
      - "Run services with least privilege"
      - "Use separate VPN profile from Kali"
      - "Enable audit logging for all operations"
      - "Implement network segmentation"

# =============================================================================
# 3. AUTHENTICATION & SECURITY
# =============================================================================
authentication:
  kubernetes_rbac:
    description: "Role-Based Access Control for agent access"
    
    service_accounts:
      - name: "agent-reader"
        namespace: "strategickhaos"
        permissions:
          - "get, list, watch pods, services, deployments"
        manifest: |
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: agent-reader
            namespace: strategickhaos
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: Role
          metadata:
            name: agent-reader-role
            namespace: strategickhaos
          rules:
          - apiGroups: ["", "apps"]
            resources: ["pods", "services", "deployments"]
            verbs: ["get", "list", "watch"]
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: RoleBinding
          metadata:
            name: agent-reader-binding
            namespace: strategickhaos
          subjects:
          - kind: ServiceAccount
            name: agent-reader
            namespace: strategickhaos
          roleRef:
            kind: Role
            name: agent-reader-role
            apiGroup: rbac.authorization.k8s.io
      
      - name: "agent-operator"
        namespace: "strategickhaos"
        permissions:
          - "All reader permissions"
          - "create, update, delete pods"
          - "execute commands in pods"
        manifest: |
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: agent-operator
            namespace: strategickhaos
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: Role
          metadata:
            name: agent-operator-role
            namespace: strategickhaos
          rules:
          - apiGroups: ["", "apps"]
            resources: ["pods", "services", "deployments", "pods/exec"]
            verbs: ["get", "list", "watch", "create", "update", "delete"]
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: RoleBinding
          metadata:
            name: agent-operator-binding
            namespace: strategickhaos
          subjects:
          - kind: ServiceAccount
            name: agent-operator
            namespace: strategickhaos
          roleRef:
            kind: Role
            name: agent-operator-role
            apiGroup: rbac.authorization.k8s.io
    
    token_management:
      description: "Secure token generation and rotation"
      rotation_policy: "30 days"
      generation_command: |
        # Generate service account token
        kubectl create token agent-reader -n strategickhaos --duration=720h
  
  api_authentication:
    methods:
      - type: "JWT tokens"
        description: "JSON Web Tokens for API authentication"
        issuer: "strategickhaos-auth"
        expiration: "24h"
        
      - type: "API Keys"
        description: "Static API keys for specific agents"
        rotation_policy: "90 days"
        storage: "Kubernetes secrets"
      
      - type: "mTLS"
        description: "Mutual TLS for high-security operations"
        certificate_authority: "Strategickhaos Internal CA"
    
    implementation:
      jwt_verification: |
        # Example JWT verification in API gateway
        import jwt
        from functools import wraps
        from flask import request, jsonify
        
        def token_required(f):
            @wraps(f)
            def decorated(*args, **kwargs):
                token = request.headers.get('Authorization')
                if not token:
                    return jsonify({'message': 'Token is missing'}), 401
                try:
                    data = jwt.decode(token, SECRET_KEY, algorithms=['HS256'])
                except:
                    return jsonify({'message': 'Token is invalid'}), 401
                return f(*args, **kwargs)
            return decorated
  
  security_policies:
    network_policies:
      description: "Kubernetes NetworkPolicies for micro-segmentation"
      manifest: |
        apiVersion: networking.k8s.io/v1
        kind: NetworkPolicy
        metadata:
          name: agent-access-policy
          namespace: strategickhaos
        spec:
          podSelector:
            matchLabels:
              tier: backend
          policyTypes:
          - Ingress
          - Egress
          ingress:
          - from:
            - namespaceSelector:
                matchLabels:
                  name: strategickhaos
            - podSelector:
                matchLabels:
                  role: agent
            ports:
            - protocol: TCP
              port: 8080
          egress:
          - to:
            - namespaceSelector: {}
            ports:
            - protocol: TCP
              port: 443
    
    pod_security:
      policy: "Restricted"
      enforcement: "Mandatory"
      standards:
        - "Run as non-root"
        - "Read-only root filesystem"
        - "Drop all capabilities"
        - "No privilege escalation"

# =============================================================================
# 4. AGENT INTERACTION & API COMMUNICATION
# =============================================================================
agent_interaction:
  api_endpoints:
    base_url: "https://api.strategickhaos.internal"
    vpn_url: "https://10.200.0.1:8080"
    
    endpoints:
      - path: "/api/v1/tasks"
        method: "GET"
        description: "List available tasks for agents"
        authentication: "JWT required"
        example: |
          curl -H "Authorization: Bearer $TOKEN" \
               https://api.strategickhaos.internal/api/v1/tasks
      
      - path: "/api/v1/tasks/{id}/execute"
        method: "POST"
        description: "Execute a specific task"
        authentication: "JWT required"
        payload:
          task_id: "string"
          parameters: "object"
        example: |
          curl -X POST \
               -H "Authorization: Bearer $TOKEN" \
               -H "Content-Type: application/json" \
               -d '{"parameters": {"target": "example.com"}}' \
               https://api.strategickhaos.internal/api/v1/tasks/scan-001/execute
      
      - path: "/api/v1/results/{task_id}"
        method: "GET"
        description: "Retrieve task results"
        authentication: "JWT required"
        example: |
          curl -H "Authorization: Bearer $TOKEN" \
               https://api.strategickhaos.internal/api/v1/results/scan-001
      
      - path: "/api/v1/logs"
        method: "GET"
        description: "Query centralized logs"
        authentication: "JWT required"
        parameters:
          - "query: LogQL query string"
          - "start: ISO8601 timestamp"
          - "end: ISO8601 timestamp"
        example: |
          curl -G \
               -H "Authorization: Bearer $TOKEN" \
               --data-urlencode 'query={job="agent"}' \
               https://api.strategickhaos.internal/api/v1/logs
      
      - path: "/api/v1/metrics"
        method: "GET"
        description: "Query Prometheus metrics"
        authentication: "JWT required"
        example: |
          curl -H "Authorization: Bearer $TOKEN" \
               'https://api.strategickhaos.internal/api/v1/metrics/query?query=up'
  
  command_execution:
    kubernetes:
      description: "Execute commands in Kubernetes pods"
      examples:
        - description: "List pods"
          command: "kubectl get pods -n strategickhaos"
        
        - description: "Get pod logs"
          command: "kubectl logs -f deployment/agent-api -n strategickhaos"
        
        - description: "Execute command in pod"
          command: "kubectl exec -it pod-name -n strategickhaos -- /bin/bash"
        
        - description: "Port forward for local access"
          command: "kubectl port-forward svc/agent-api 8080:80 -n strategickhaos"
    
    docker:
      description: "Interact with Docker containers"
      examples:
        - description: "List running containers"
          command: "docker ps"
        
        - description: "View container logs"
          command: "docker logs -f container-name"
        
        - description: "Execute command in container"
          command: "docker exec -it container-name /bin/bash"
        
        - description: "Inspect container"
          command: "docker inspect container-name | jq ."

# =============================================================================
# 5. COLLABORATION WORKFLOWS
# =============================================================================
collaboration:
  shared_tools:
    jupyter_notebooks:
      description: "Collaborative data analysis and visualization"
      deployment:
        type: "JupyterHub on Kubernetes"
        namespace: "collaboration"
        access: "https://jupyter.strategickhaos.internal"
        authentication: "SSO with LDAP"
      
      features:
        - "Shared notebook repositories"
        - "Real-time collaboration"
        - "Version control integration"
        - "Custom kernels for different languages"
    
    grafana_dashboards:
      description: "Shared observability and monitoring dashboards"
      deployment:
        type: "Grafana on Kubernetes"
        namespace: "monitoring"
        access: "https://grafana.strategickhaos.internal"
      
      dashboards:
        - name: "Agent Activity"
          description: "Real-time agent task execution and performance"
        
        - name: "Infrastructure Health"
          description: "Kubernetes and Docker infrastructure metrics"
        
        - name: "Security Events"
          description: "Security alerts and threat detection"
        
        - name: "API Performance"
          description: "API gateway metrics and latency"
    
    collaboration_platforms:
      - name: "GitLab"
        purpose: "Code collaboration and CI/CD"
        url: "https://gitlab.strategickhaos.internal"
        features:
          - "Shared repositories"
          - "CI/CD pipelines"
          - "Issue tracking"
          - "Code review"
      
      - name: "Mattermost"
        purpose: "Real-time team communication"
        url: "https://chat.strategickhaos.internal"
        channels:
          - "#general - General discussions"
          - "#agents - Agent coordination"
          - "#incidents - Incident response"
          - "#dev - Development chat"
      
      - name: "Wiki.js"
        purpose: "Collaborative documentation"
        url: "https://wiki.strategickhaos.internal"
        sections:
          - "Architecture documentation"
          - "Runbooks and procedures"
          - "Troubleshooting guides"
          - "API documentation"
  
  logging_monitoring:
    centralized_logging:
      stack: "Loki + Promtail + Grafana"
      description: "Centralized log aggregation and analysis"
      
      components:
        - name: "Loki"
          purpose: "Log aggregation backend"
          url: "http://10.200.0.1:3100"
        
        - name: "Promtail"
          purpose: "Log shipper"
          config: "Deployed as DaemonSet on all nodes"
        
        - name: "Grafana"
          purpose: "Log visualization and querying"
          url: "https://grafana.strategickhaos.internal"
      
      log_queries:
        - description: "Agent task logs"
          query: '{job="agent"} |= "task_id"'
        
        - description: "Error logs from all services"
          query: '{namespace="strategickhaos"} |= "error" or "ERROR"'
        
        - description: "API request logs"
          query: '{app="api-gateway"} | json | line_format "{{.method}} {{.path}} {{.status}}"'
    
    metrics_monitoring:
      stack: "Prometheus + Grafana"
      description: "Time-series metrics collection and alerting"
      
      components:
        - name: "Prometheus"
          purpose: "Metrics collection and storage"
          url: "http://10.200.0.1:9090"
          scrape_interval: "15s"
        
        - name: "Alertmanager"
          purpose: "Alert routing and management"
          url: "http://10.200.0.1:9093"
        
        - name: "Node Exporter"
          purpose: "Host metrics collection"
          deployment: "DaemonSet on all nodes"
      
      key_metrics:
        - metric: "agent_task_duration_seconds"
          type: "histogram"
          description: "Task execution duration"
        
        - metric: "agent_task_total"
          type: "counter"
          description: "Total tasks executed by agents"
        
        - metric: "api_request_duration_seconds"
          type: "histogram"
          description: "API request latency"
        
        - metric: "kubernetes_pod_status"
          type: "gauge"
          description: "Pod health status"
      
      alerts:
        - name: "HighTaskFailureRate"
          condition: "rate(agent_task_failed_total[5m]) > 0.1"
          severity: "warning"
          action: "Notify #agents channel"
        
        - name: "APIHighLatency"
          condition: "histogram_quantile(0.95, api_request_duration_seconds) > 1"
          severity: "warning"
          action: "Notify #incidents channel"
        
        - name: "PodCrashLooping"
          condition: "rate(kube_pod_container_status_restarts_total[15m]) > 0"
          severity: "critical"
          action: "Page on-call engineer"

# =============================================================================
# 6. DOCUMENTATION & TRAINING
# =============================================================================
documentation:
  shared_repositories:
    github:
      url: "https://github.com/Strategickhaos-Swarm-Intelligence"
      repositories:
        - name: "sovereignty-architecture"
          purpose: "Main infrastructure and architecture documentation"
        
        - name: "agent-collaboration"
          purpose: "Agent collaboration guides and examples"
        
        - name: "security-playbooks"
          purpose: "Security procedures and incident response"
    
    wiki:
      platform: "Wiki.js"
      url: "https://wiki.strategickhaos.internal"
      structure:
        - section: "Getting Started"
          pages:
            - "Agent Onboarding Guide"
            - "Environment Setup"
            - "Authentication Configuration"
        
        - section: "API Documentation"
          pages:
            - "API Reference"
            - "Authentication Methods"
            - "Rate Limits and Quotas"
        
        - section: "Runbooks"
          pages:
            - "Common Tasks"
            - "Troubleshooting Guide"
            - "Incident Response Procedures"
        
        - section: "Architecture"
          pages:
            - "Infrastructure Overview"
            - "Network Topology"
            - "Security Architecture"
  
  training_resources:
    - type: "Onboarding Workshop"
      duration: "2 hours"
      topics:
        - "Introduction to Sovereignty Architecture"
        - "VPN setup and connectivity"
        - "API authentication and usage"
        - "Kubernetes basics for agents"
        - "Monitoring and logging overview"
    
    - type: "Security Training"
      duration: "1 hour"
      topics:
        - "Security best practices"
        - "Incident response procedures"
        - "Data handling and privacy"
        - "Threat intelligence sharing"
    
    - type: "Advanced Topics"
      duration: "Ongoing"
      topics:
        - "Advanced Kubernetes operations"
        - "Custom agent development"
        - "Performance optimization"
        - "Distributed tracing and debugging"

# =============================================================================
# IMPLEMENTATION CHECKLIST
# =============================================================================
implementation_checklist:
  network:
    - "[ ] Deploy WireGuard VPN server"
    - "[ ] Generate and distribute VPN client configurations"
    - "[ ] Configure firewall rules for VPN subnet"
    - "[ ] Set up port forwarding for Docker services"
    - "[ ] Create Kubernetes NodePort services"
    - "[ ] Test VPN connectivity from Kali and Parrot OS"
  
  environment:
    - "[ ] Install required tools on Kali Linux"
    - "[ ] Install required tools on Parrot OS"
    - "[ ] Configure kubectl with cluster credentials"
    - "[ ] Set up Docker registry authentication"
    - "[ ] Test basic connectivity to services"
  
  authentication:
    - "[ ] Create Kubernetes service accounts for agents"
    - "[ ] Generate and distribute JWT tokens"
    - "[ ] Implement RBAC policies"
    - "[ ] Deploy NetworkPolicies"
    - "[ ] Configure API gateway authentication"
  
  collaboration:
    - "[ ] Deploy JupyterHub for collaborative analysis"
    - "[ ] Set up Grafana dashboards"
    - "[ ] Deploy centralized logging (Loki + Promtail)"
    - "[ ] Configure Prometheus metrics collection"
    - "[ ] Set up alerting rules and notifications"
  
  documentation:
    - "[ ] Create agent onboarding documentation"
    - "[ ] Write API usage guides"
    - "[ ] Publish runbooks and procedures"
    - "[ ] Conduct training sessions"
    - "[ ] Establish feedback and improvement process"

# =============================================================================
# METADATA
# =============================================================================
metadata:
  version: "1.0"
  created: "2025-11-23T22:28:12Z"
  author: "Strategickhaos Sovereignty Architecture Team"
  maintained_by: "Node 137 / Domenic Garza"
  
  related_documents:
    - "sovereignty_genome.yaml"
    - "discovery.yml"
    - "docker-compose.yml"
    - "README.md"
  
  verification:
    tested: false
    review_required: true
    security_audit: "Required before production deployment"

# === END OF AGENT COLLABORATION CONFIGURATION ===
