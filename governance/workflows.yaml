# workflows.yaml
# Strategickhaos DAO LLC â€” Autonomy Spine Layer 6: COHESION
# All Automated Processes Defined
version: "1.0"
created: "2025-11-28"
updated: "2025-11-28"

# Purpose: Define all system processes for autonomous operation
# System operates without constant human attention

metadata:
  layer: "Layer 6: COHESION (System Unity)"
  autonomy_function: "All processes defined and automated where possible"
  dependencies:
    - "governance/SUM.yaml"
    - "governance/covenant.yaml"
    - "governance/routing_logic.yaml"

# =============================================================================
# WORKFLOW DEFINITIONS
# =============================================================================

workflows:
  # -------------------------------------------------------------------------
  # LAYER 1: MEMORY WORKFLOWS
  # -------------------------------------------------------------------------
  state_update:
    id: "wf-001"
    name: "State Update Workflow"
    layer: 1
    automation_level: "full"
    
    description: "Automatically refresh system state from all sources"
    
    trigger:
      type: "scheduled"
      schedule: "daily at 00:00 UTC"
      manual_override: true
      
    steps:
      - step: 1
        action: "Run state_updater.py"
        input: "All configured data sources"
        output: "strategickhaos_state_snapshot.json"
        
      - step: 2
        action: "Compute hash of new state"
        algorithm: "SHA-256"
        output: "state_hash"
        
      - step: 3
        action: "Append to provenance log"
        output: "provenance.log.jsonl"
        
      - step: 4
        action: "Notify on significant changes"
        threshold: "material_change_detected"
        
    failure_handling:
      retry: 3
      escalation: "notify_managing_member"
      fallback: "use_previous_state"

  provenance_logging:
    id: "wf-002"
    name: "Provenance Logging Workflow"
    layer: 1
    automation_level: "full"
    
    description: "Log all significant actions with cryptographic proof"
    
    trigger:
      type: "event"
      events:
        - "state_change"
        - "governance_decision"
        - "distribution_executed"
        - "covenant_check"
        
    steps:
      - step: 1
        action: "Capture event details"
        fields: ["timestamp", "actor", "action", "target", "outcome"]
        
      - step: 2
        action: "Compute event hash"
        algorithm: "Blake3"
        
      - step: 3
        action: "Append to provenance log"
        format: "JSON Lines"
        
      - step: 4
        action: "Periodic anchor to OpenTimestamps"
        frequency: "weekly"

  # -------------------------------------------------------------------------
  # LAYER 2: INTELLIGENCE WORKFLOWS
  # -------------------------------------------------------------------------
  governance_decision:
    id: "wf-003"
    name: "Governance Decision Workflow"
    layer: 2
    automation_level: "partial"
    
    description: "Process governance decisions with AI board assistance"
    
    trigger:
      type: "event"
      events:
        - "proposal_submitted"
        - "emergency_declared"
        - "scheduled_review"
        
    steps:
      - step: 1
        action: "Load current state"
        source: "strategickhaos_state_snapshot.json"
        
      - step: 2
        action: "Load relevant risks"
        source: "risks_from_corpus.json"
        
      - step: 3
        action: "Invoke governance board agent"
        input: "Proposal + State + Risks"
        output: "Recommendation with reasoning"
        
      - step: 4
        action: "Check covenant compliance"
        source: "governance/covenant.yaml"
        
      - step: 5
        action: "Present to human authority"
        authority: "managing_member"
        decision_type: "approve/reject/modify"
        
      - step: 6
        action: "Log decision and rationale"
        output: "provenance.log.jsonl"
        
    failure_handling:
      timeout: "72 hours for human response"
      escalation: "secondary authority"
      default: "conservative (reject if uncertain)"

  risk_assessment:
    id: "wf-004"
    name: "Risk Assessment Workflow"
    layer: 2
    automation_level: "full"
    
    description: "Evaluate risks against historical evidence"
    
    trigger:
      type: "event"
      events:
        - "proposal_received"
        - "environment_change"
        - "scheduled_review"
        
    steps:
      - step: 1
        action: "Identify risk category"
        input: "Proposal or change description"
        
      - step: 2
        action: "Query risks bibliography"
        source: "risks_bibliography.json"
        match_criteria: "category + severity"
        
      - step: 3
        action: "Generate risk report"
        output: "historical_precedents + risk_score + recommendations"
        
      - step: 4
        action: "Attach to decision workflow"
        target: "governance_decision workflow"

  # -------------------------------------------------------------------------
  # LAYER 3: INTEGRITY WORKFLOWS
  # -------------------------------------------------------------------------
  evidence_verification:
    id: "wf-005"
    name: "Evidence Verification Workflow"
    layer: 3
    automation_level: "full"
    
    description: "Verify all public claims have supporting evidence"
    
    trigger:
      type: "scheduled"
      schedule: "daily at 06:00 UTC"
      manual_override: true
      
    steps:
      - step: 1
        action: "Run verify_evidence.py"
        scope: "All claims in evidence_dossier"
        
      - step: 2
        action: "Check cryptographic anchors"
        methods: ["GPG signature", "OpenTimestamps", "Blake3 hash"]
        
      - step: 3
        action: "Generate verification report"
        output: "evidence_verification_report.json"
        
      - step: 4
        action: "Alert on failures"
        threshold: "any_verification_failure"
        notification: "managing_member"
        
    failure_handling:
      on_failure: "quarantine_unverified_claim"
      escalation: "immediate"

  infrastructure_check:
    id: "wf-006"
    name: "Infrastructure Health Check Workflow"
    layer: 3
    automation_level: "full"
    
    description: "Verify system infrastructure is healthy"
    
    trigger:
      type: "scheduled"
      schedule: "every 6 hours"
      manual_override: true
      
    steps:
      - step: 1
        action: "Run status_verify.py"
        checks: ["services", "certificates", "storage", "connectivity"]
        
      - step: 2
        action: "Compare against status_manifest.yaml"
        output: "deviation_report"
        
      - step: 3
        action: "Auto-remediate if possible"
        scope: "restartable services only"
        
      - step: 4
        action: "Alert on critical failures"
        threshold: "service_down OR certificate_expiring"
        notification: ["managing_member", "ops_channel"]

  # -------------------------------------------------------------------------
  # LAYER 4: MORALITY WORKFLOWS
  # -------------------------------------------------------------------------
  covenant_compliance:
    id: "wf-007"
    name: "Covenant Compliance Check Workflow"
    layer: 4
    automation_level: "full"
    
    description: "Verify all actions comply with ethical covenants"
    
    trigger:
      type: "event"
      events:
        - "pre_action"
        - "scheduled_audit"
        
    steps:
      - step: 1
        action: "Load covenant constraints"
        source: "governance/covenant.yaml"
        
      - step: 2
        action: "Evaluate action against constraints"
        checks:
          - "non_exploitation"
          - "no_scam"
          - "value_preservation"
          - "fair_compensation"
          
      - step: 3
        action: "Generate compliance verdict"
        output: "pass/fail with reasoning"
        
      - step: 4
        action: "Block if violation detected"
        response: "reject_action + log_violation"
        
      - step: 5
        action: "Log compliance check"
        output: "covenant_enforcement.log.jsonl"
        
    failure_handling:
      on_violation:
        minor: "log and continue with warning"
        moderate: "pause and escalate"
        severe: "halt and notify"
        critical: "system shutdown"

  value_drift_detection:
    id: "wf-008"
    name: "Value Drift Detection Workflow"
    layer: 4
    automation_level: "full"
    
    description: "Monitor for gradual deviation from protected values"
    
    trigger:
      type: "scheduled"
      schedule: "daily at 12:00 UTC"
      
    steps:
      - step: 1
        action: "Load protected values"
        source: "governance/covenant.yaml"
        
      - step: 2
        action: "Analyze recent decisions and actions"
        window: "30 days"
        
      - step: 3
        action: "Compute alignment score"
        baseline: "Original value definitions"
        
      - step: 4
        action: "Alert on drift detected"
        threshold: "alignment_score < 0.85"
        notification: "governance_board"

  # -------------------------------------------------------------------------
  # LAYER 5: PURPOSE WORKFLOWS
  # -------------------------------------------------------------------------
  monthly_distribution:
    id: "wf-009"
    name: "Monthly 7% Distribution Workflow"
    layer: 5
    automation_level: "partial"
    
    description: "Calculate and distribute 7% to charity monthly"
    
    trigger:
      type: "scheduled"
      schedule: "1st of each month at 09:00 UTC"
      
    steps:
      - step: 1
        action: "Aggregate monthly revenue"
        sources: "Per routing_logic.yaml revenue_detection"
        
      - step: 2
        action: "Apply allowable deductions"
        rules: "Per routing_logic.yaml calculation"
        
      - step: 3
        action: "Calculate 7% amount"
        formula: "net_revenue * 0.07"
        
      - step: 4
        action: "Allocate to beneficiaries"
        rules: "Per charity_manifest.yaml allocation"
        
      - step: 5
        action: "Generate distribution proposal"
        output: "distribution_proposal.json"
        
      - step: 6
        action: "Request approval"
        authority: "managing_member"
        deadline: "5 business days"
        
      - step: 7
        action: "Execute transfers"
        condition: "approval_received"
        
      - step: 8
        action: "Verify transfers completed"
        checks: ["receipt_confirmed", "amount_correct"]
        
      - step: 9
        action: "Log to distribution tracker"
        output: "distribution_tracker.json"
        
      - step: 10
        action: "Generate public report"
        output: "monthly_distribution_report.md"
        delay: "30 days"
        
    failure_handling:
      approval_timeout:
        action: "escalate_to_secondary_authority"
        deadline: "additional 5 days"
      transfer_failure:
        action: "retry 3 times then manual intervention"
      verification_failure:
        action: "flag for investigation"

  beneficiary_verification:
    id: "wf-010"
    name: "Beneficiary Verification Workflow"
    layer: 5
    automation_level: "partial"
    
    description: "Quarterly verification of beneficiary eligibility"
    
    trigger:
      type: "scheduled"
      schedule: "1st day of each quarter"
      
    steps:
      - step: 1
        action: "Load beneficiary registry"
        source: "governance/charity_manifest.yaml"
        
      - step: 2
        action: "Check 501c3 status"
        source: "IRS Tax Exempt Organization Search"
        
      - step: 3
        action: "Check charity ratings"
        sources: ["Charity Navigator", "GuideStar", "BBB"]
        
      - step: 4
        action: "Check sanctions lists"
        sources: ["OFAC", "UN", "EU"]
        
      - step: 5
        action: "Generate verification report"
        output: "beneficiary_verification_report.json"
        
      - step: 6
        action: "Flag issues for review"
        threshold: "any_check_failed"
        notification: "governance_board"
        
      - step: 7
        action: "Update manifest"
        changes: ["verification_dates", "status_changes"]

  # -------------------------------------------------------------------------
  # LAYER 6: COHESION WORKFLOWS
  # -------------------------------------------------------------------------
  system_self_check:
    id: "wf-011"
    name: "System Self-Check Workflow"
    layer: 6
    automation_level: "full"
    
    description: "Verify complete system ontology integrity"
    
    trigger:
      type: "scheduled"
      schedule: "weekly on Sunday at 00:00 UTC"
      
    steps:
      - step: 1
        action: "Validate SUM.yaml references"
        check: "All referenced files exist"
        
      - step: 2
        action: "Validate workflow definitions"
        check: "All workflows have required fields"
        
      - step: 3
        action: "Validate covenant enforcement"
        check: "Covenant checks are operational"
        
      - step: 4
        action: "Validate distribution logic"
        check: "7% routing is configured correctly"
        
      - step: 5
        action: "Generate system health report"
        output: "system_health_report.json"
        
      - step: 6
        action: "Update autonomy_spine.md if needed"
        condition: "material_changes_detected"

  documentation_sync:
    id: "wf-012"
    name: "Documentation Sync Workflow"
    layer: 6
    automation_level: "partial"
    
    description: "Keep documentation synchronized with system state"
    
    trigger:
      type: "event"
      events:
        - "governance_file_changed"
        - "monthly_review"
        
    steps:
      - step: 1
        action: "Detect documentation drift"
        compare: "Code/config vs documentation"
        
      - step: 2
        action: "Generate update suggestions"
        output: "documentation_updates.md"
        
      - step: 3
        action: "Request review"
        authority: "managing_member"
        
      - step: 4
        action: "Apply approved updates"
        condition: "approval_received"

# =============================================================================
# WORKFLOW ORCHESTRATION
# =============================================================================
orchestration:
  dependencies:
    - workflow: "monthly_distribution"
      depends_on: ["state_update", "covenant_compliance"]
      
    - workflow: "governance_decision"
      depends_on: ["risk_assessment", "covenant_compliance"]
      
    - workflow: "system_self_check"
      depends_on: ["infrastructure_check", "evidence_verification"]

  conflict_resolution:
    rule: "covenant_compliance takes precedence"
    
  scheduling:
    priority_order:
      - "covenant_compliance"
      - "infrastructure_check"
      - "state_update"
      - "monthly_distribution"
      - "system_self_check"

# =============================================================================
# MONITORING
# =============================================================================
monitoring:
  metrics:
    - name: "workflow_success_rate"
      threshold: 0.95
      
    - name: "workflow_execution_time"
      threshold: "varies by workflow"
      
    - name: "covenant_violation_count"
      threshold: 0
      
  alerting:
    channels:
      - "managing_member_email"
      - "discord_ops_channel"
      
    escalation:
      - level: 1
        delay: "0 minutes"
        recipients: ["ops_channel"]
        
      - level: 2
        delay: "30 minutes"
        recipients: ["managing_member"]
        
      - level: 3
        delay: "4 hours"
        recipients: ["governance_board"]

# =============================================================================
# SIGNATURE
# =============================================================================
signature:
  signer: "Domenic Garza"
  role: "Managing Member"
  date: "2025-11-28"
  gpg_fingerprint: "TBD - To be signed"
  commitment: "These workflows define the operational processes for the Autonomy Spine"
