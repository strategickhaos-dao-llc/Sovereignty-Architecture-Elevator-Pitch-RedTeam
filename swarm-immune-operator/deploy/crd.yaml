---
# CustomResourceDefinition for ImmuneSystem
# This is the "DNA" that defines the structure of our immune system
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: immunesystems.swarm.strategickhaos.ai
  labels:
    app: swarm-immune-operator
    component: crd
spec:
  group: swarm.strategickhaos.ai
  names:
    kind: ImmuneSystem
    listKind: ImmuneSystemList
    plural: immunesystems
    singular: immunesystem
    shortNames:
      - immune
      - is
  scope: Namespaced
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                redBloodCells:
                  type: object
                  description: "Transport layer configuration (oxygen carriers)"
                  properties:
                    transport:
                      type: string
                      enum: ["redis", "kafka", "nats"]
                      default: "redis"
                      description: "Transport mechanism type"
                    replicas:
                      type: integer
                      minimum: 1
                      default: 3
                      description: "Number of transport replicas"
                whiteBloodCells:
                  type: object
                  description: "Security scanner configuration (immune defenders)"
                  properties:
                    scanner:
                      type: string
                      enum: ["falco", "trivy"]
                      default: "falco"
                      description: "Scanner type for threat detection"
                    responseTime:
                      type: string
                      default: "5s"
                      description: "Response time for threat detection"
                    quarantineNamespace:
                      type: string
                      default: "infected"
                      description: "Namespace for quarantined workloads"
                    autoKill:
                      type: boolean
                      default: true
                      description: "Automatically terminate infected pods"
                antibodies:
                  type: object
                  description: "Vector memory configuration (threat signature memory)"
                  properties:
                    vectorDB:
                      type: string
                      enum: ["qdrant", "milvus", "pinecone"]
                      default: "qdrant"
                      description: "Vector database for signature storage"
                    signatureRetention:
                      type: string
                      default: "90d"
                      description: "Duration to retain threat signatures"
                circadianRhythm:
                  type: object
                  description: "Day/night scaling configuration (activity cycles)"
                  properties:
                    sunshineHours:
                      type: string
                      default: "06:00-22:00"
                      description: "Active hours in HH:MM-HH:MM format"
                    moonlightHours:
                      type: string
                      default: "22:00-06:00"
                      description: "Sleep hours in HH:MM-HH:MM format"
                    sunshineReplicas:
                      type: integer
                      minimum: 1
                      default: 10
                      description: "Replicas during active hours"
                    moonlightReplicas:
                      type: integer
                      minimum: 1
                      default: 2
                      description: "Replicas during sleep hours"
                autoimmune:
                  type: object
                  description: "Self-protection configuration (don't attack self)"
                  properties:
                    enabled:
                      type: boolean
                      default: false
                      description: "Enable autoimmune protection"
                    trustedImages:
                      type: array
                      items:
                        type: string
                      description: "List of trusted image patterns"
            status:
              type: object
              properties:
                redBloodCells:
                  type: object
                  properties:
                    ready:
                      type: integer
                    desired:
                      type: integer
                    message:
                      type: string
                whiteBloodCells:
                  type: object
                  properties:
                    ready:
                      type: integer
                    desired:
                      type: integer
                    message:
                      type: string
                antibodiesLoaded:
                  type: integer
                  description: "Number of threat signatures loaded"
                circadianMode:
                  type: string
                  enum: ["sunshine", "moonlight"]
                  description: "Current activity mode"
                lastHeartbeat:
                  type: string
                  format: date-time
                  description: "Last reconciliation timestamp"
                health:
                  type: string
                  enum: ["ALIVE", "DEGRADED", "DEAD"]
                  description: "Overall system health"
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
                      reason:
                        type: string
                      message:
                        type: string
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Health
          type: string
          jsonPath: .status.health
          description: "Overall health status"
        - name: Mode
          type: string
          jsonPath: .status.circadianMode
          description: "Current circadian mode"
        - name: RBC
          type: string
          jsonPath: .status.redBloodCells.message
          description: "Red blood cells status"
        - name: WBC
          type: string
          jsonPath: .status.whiteBloodCells.message
          description: "White blood cells status"
        - name: Antibodies
          type: integer
          jsonPath: .status.antibodiesLoaded
          description: "Loaded antibody signatures"
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
