# Bloodline Manifest - Source of Truth for Container Refinery
# This defines WHAT SHOULD BE RUNNING across all nodes
# Every container birth, death, and mutation flows through this manifest

refinery:
  version: 1.0.0
  name: "Container Refinery - Immune System"
  description: "GitOps enforcement and drift detection for Docker/K8s clusters"
  
nodes:
  - name: lyra
    role: primary
    type: windows
    hostname: nitro-v15-lyra
    docker_enabled: true
    k8s_enabled: true
    monitoring: true
    
  - name: node1
    role: worker
    type: windows
    docker_enabled: true
    k8s_enabled: true
    monitoring: true
    
  - name: node2
    role: worker
    type: windows
    docker_enabled: true
    k8s_enabled: true
    monitoring: true
    
  - name: node3
    role: worker
    type: windows
    docker_enabled: true
    k8s_enabled: true
    monitoring: true

config:
  # Monitoring settings
  check_interval: 60  # seconds - runs every 60 seconds
  drift_detection: true
  auto_rollback: true
  enforcement_mode: active  # active, passive, audit
  
  # Ledger settings
  ledger_retention_days: 365
  ledger_format: jsonl
  ledger_auto_rotate: true
  
  # Git settings
  git_auto_commit: true
  git_commit_interval: 300  # seconds (5 minutes)
  git_branch: main
  git_remote: origin
  
  # Notifications
  discord_webhook: ""  # Optional Discord webhook for alerts
  email_alerts: []  # Optional email addresses for critical alerts
  
  # Security
  allow_manual_overrides: false  # If true, allows temporary drift for maintenance
  grace_period_seconds: 300  # Grace period before auto-rollback

# Flux v2 Configuration (Air-gapped)
flux:
  enabled: true
  offline_mode: true
  sync_interval: 60  # seconds
  source: local
  local_path: "./manifests"
  
# Container Definitions - The Source of Truth
# These are the ONLY containers that should exist
# Everything else is considered drift and will be terminated

containers:
  # Example Docker containers
  # - name: refinory-api
  #   type: docker
  #   image: refinory-ai:latest
  #   image_sha: sha256:abc123...
  #   node: lyra
  #   ports:
  #     - "8085:8085"
  #   environment:
  #     REFINORY_ENV: production
  #   labels:
  #     app: refinory
  #     tier: api
  #   restart_policy: always
  #   bloodline:
  #     creator: deployment-script
  #     created_at: "2025-01-20T00:00:00Z"
  #     purpose: "AI agent orchestration API"
  
  # Example Kubernetes pods
  # - name: discord-bot
  #   type: kubernetes
  #   namespace: default
  #   image: discord-ops-bot:latest
  #   image_sha: sha256:def456...
  #   node: lyra
  #   replicas: 1
  #   labels:
  #     app: discord-bot
  #     tier: automation
  #   bloodline:
  #     creator: kubectl-apply
  #     created_at: "2025-01-20T00:00:00Z"
  #     purpose: "Discord DevOps automation"

# Drift Detection Rules
drift_rules:
  # Rule 1: Unauthorized containers (not in manifest)
  unauthorized_containers:
    action: terminate  # terminate, alert, ignore
    grace_period: 60  # seconds before action
    exceptions: []  # List of container name patterns to ignore
    
  # Rule 2: Image drift (wrong version)
  image_drift:
    action: rollback  # rollback, alert, ignore
    grace_period: 300  # seconds before action
    allow_newer_patches: false  # If true, allows patch version updates
    
  # Rule 3: Missing containers (in manifest but not running)
  missing_containers:
    action: recreate  # recreate, alert, ignore
    grace_period: 120  # seconds before action
    
  # Rule 4: Configuration drift
  config_drift:
    action: alert  # rollback, alert, ignore
    grace_period: 300  # seconds before action
    check_env_vars: true
    check_ports: true
    check_volumes: true

# Rollback Configuration
rollback:
  enabled: true
  max_retries: 3
  retry_delay: 30  # seconds
  backup_before_rollback: true
  backup_retention: 7  # days
  
  # Rollback methods per platform
  docker:
    method: compose  # compose, cli, api
    compose_file: "./manifests/docker/docker-compose.yml"
    
  kubernetes:
    method: kubectl  # kubectl, helm, flux
    manifest_path: "./manifests/k8s/"

# Audit and Compliance
audit:
  enabled: true
  log_all_events: true
  log_level: info  # debug, info, warning, error
  
  # What to track
  track_container_creation: true
  track_container_deletion: true
  track_image_changes: true
  track_config_changes: true
  track_network_changes: true
  track_volume_changes: true
  
  # Compliance requirements
  require_git_approval: false  # If true, all changes must be in git first
  require_signed_commits: false  # If true, requires GPG-signed commits
  immutable_ledger: true  # Ledger cannot be edited

# Bloodline Provenance
# Tracks the lineage of every container
provenance:
  enabled: true
  track_creator: true  # Who/what created the container
  track_parent_image: true  # Base image lineage
  track_build_pipeline: true  # CI/CD pipeline that built it
  track_approvers: true  # Who approved the deployment
  track_dependencies: true  # Container dependencies
  
# Health Checks
health_checks:
  enabled: true
  interval: 60  # seconds
  
  # Check Docker daemon
  check_docker: true
  docker_timeout: 10  # seconds
  
  # Check Kubernetes cluster
  check_kubernetes: true
  k8s_timeout: 10  # seconds
  
  # Check git repository
  check_git: true
  git_timeout: 5  # seconds

# Alerting
alerting:
  enabled: true
  
  # Alert channels
  channels:
    - type: log
      level: all
      
    # - type: discord
    #   webhook_url: ""
    #   level: warning  # info, warning, error, critical
    #   
    # - type: email
    #   recipients: []
    #   level: error
  
  # Alert conditions
  conditions:
    - name: unauthorized_container
      severity: critical
      message: "Unauthorized container detected and terminated"
      
    - name: drift_detected
      severity: warning
      message: "Container drift detected"
      
    - name: rollback_failed
      severity: critical
      message: "Auto-rollback failed"
      
    - name: health_check_failed
      severity: error
      message: "Health check failed"

# Maintenance Windows
# During maintenance, drift detection can be temporarily disabled
maintenance_windows: []
  # - name: "Weekly Maintenance"
  #   day: sunday
  #   start_time: "02:00"
  #   end_time: "04:00"
  #   timezone: "UTC"
  #   disable_auto_rollback: true
  #   allow_drift: true

# Metadata
metadata:
  deployment_date: ""  # Auto-populated on deployment
  last_update: ""  # Auto-populated on update
  version_history: []  # Auto-populated with git commits
