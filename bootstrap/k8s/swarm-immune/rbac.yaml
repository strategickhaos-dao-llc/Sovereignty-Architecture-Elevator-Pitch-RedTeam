apiVersion: v1
kind: ServiceAccount
metadata:
  name: swarm-immune-controller
  namespace: ops
  labels:
    app: swarm-immune
    component: controller
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: swarm-immune-controller
  labels:
    app: swarm-immune
rules:
  # ImmuneSystem CR management
  - apiGroups: ["swarm.strategickhaos.ai"]
    resources: ["immunesystems"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["swarm.strategickhaos.ai"]
    resources: ["immunesystems/status"]
    verbs: ["get", "update", "patch"]
  - apiGroups: ["swarm.strategickhaos.ai"]
    resources: ["immunesystems/finalizers"]
    verbs: ["update"]

  # Pod management (White Blood Cells - threat response)
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch", "create", "delete", "patch"]
  - apiGroups: [""]
    resources: ["pods/log", "pods/status"]
    verbs: ["get", "list"]
  # Note: pods/exec is intentionally omitted for security
  # The controller uses pod deletion and network policies for threat response

  # Deployment management (Apoptosis, Circadian scaling)
  - apiGroups: ["apps"]
    resources: ["deployments", "replicasets", "statefulsets", "daemonsets"]
    verbs: ["get", "list", "watch", "patch", "update"]
  - apiGroups: ["apps"]
    resources: ["deployments/scale", "replicasets/scale", "statefulsets/scale"]
    verbs: ["get", "patch", "update"]

  # Service and endpoint discovery (Bloodstream mapping)
  - apiGroups: [""]
    resources: ["services", "endpoints"]
    verbs: ["get", "list", "watch"]

  # Namespace management (Quarantine)
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["get", "list", "watch", "create", "patch"]

  # Network policies (Threat neutralization)
  - apiGroups: ["networking.k8s.io"]
    resources: ["networkpolicies"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  # ConfigMaps and Secrets
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "watch"]

  # Events for audit logging
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]

  # PersistentVolumeClaims (Bloodstream volumes)
  - apiGroups: [""]
    resources: ["persistentvolumeclaims"]
    verbs: ["get", "list", "watch"]

  # Metrics and monitoring
  - apiGroups: ["metrics.k8s.io"]
    resources: ["pods", "nodes"]
    verbs: ["get", "list"]

  # HPA management (Circadian rhythm scaling)
  - apiGroups: ["autoscaling"]
    resources: ["horizontalpodautoscalers"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  # CronJobs (Garbage collection scheduling)
  - apiGroups: ["batch"]
    resources: ["jobs", "cronjobs"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  # Coordination (Leader election)
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: swarm-immune-controller
  labels:
    app: swarm-immune
subjects:
  - kind: ServiceAccount
    name: swarm-immune-controller
    namespace: ops
roleRef:
  kind: ClusterRole
  name: swarm-immune-controller
  apiGroup: rbac.authorization.k8s.io
---
# Network Policy for controller security
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: swarm-immune-controller-netpol
  namespace: ops
  labels:
    app: swarm-immune
spec:
  podSelector:
    matchLabels:
      app: swarm-immune
      component: controller
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow Prometheus scraping
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
      ports:
        - protocol: TCP
          port: 9090
    # Allow health checks
    - from:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 8080
  egress:
    # Allow DNS resolution
    - to: []
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # Allow Kubernetes API server
    - to: []
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 6443
    # Allow vector database communication
    - to: []
      ports:
        - protocol: TCP
          port: 6333  # Qdrant
        - protocol: TCP
          port: 6334  # Qdrant gRPC
        - protocol: TCP
          port: 19530 # Milvus
        - protocol: TCP
          port: 5432  # PostgreSQL/pgvector
    # Allow message queue communication (Red Blood Cells)
    - to: []
      ports:
        - protocol: TCP
          port: 6379  # Redis
        - protocol: TCP
          port: 4222  # NATS
        - protocol: TCP
          port: 9092  # Kafka
        - protocol: TCP
          port: 5672  # RabbitMQ
