# prometheus.yml â€” Sovereign Swarm v2.0
# Prometheus Configuration with NATS Bridge (Evolution #9)
# Metrics collection for WireGuard, NATS, and swarm nodes
#
# Strategickhaos DAO LLC / Valoryield Engine
# Author: Domenic Garza (Node 137)

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    swarm: 'sovereign-swarm'
    cluster: 'primary'

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

# Rule files
rule_files:
  - /etc/prometheus/rules/*.yml

# Scrape configurations
scrape_configs:
  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          node: 'prometheus'

  # Node exporters (all swarm nodes)
  - job_name: 'swarm-nodes'
    static_configs:
      # Core nodes
      - targets:
          - '10.44.0.1:9100'  # Command-0
          - '10.44.1.1:9100'  # Fixed-1
          - '10.44.2.1:9100'  # Mobile-2
        labels:
          tier: 'core'
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: '([^:]+):.*'
        replacement: '${1}'

  # Pelican nodes (dynamic discovery)
  - job_name: 'pelican-nodes'
    static_configs:
      - targets:
          - '10.44.100.1:9100'
        labels:
          tier: 'edge'
    # File-based service discovery for dynamic pelicans
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/pelicans.json
        refresh_interval: 30s

  # NATS Server metrics
  - job_name: 'nats-server'
    static_configs:
      - targets:
          - '10.44.0.1:8222'  # Command-0 NATS
          - '10.44.1.1:8222'  # Fixed-1 NATS
          - '10.44.2.1:8222'  # Mobile-2 NATS
        labels:
          service: 'nats'
    metrics_path: /varz
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: '([^:]+):.*'
        replacement: '${1}'

  # NATS JetStream metrics
  - job_name: 'nats-jetstream'
    static_configs:
      - targets:
          - '10.44.0.1:8222'
    metrics_path: /jsz
    params:
      all: ['true']

  # Matrix Synapse metrics
  - job_name: 'matrix-synapse'
    static_configs:
      - targets:
          - '10.44.0.1:9000'
        labels:
          service: 'matrix'
    metrics_path: /_synapse/metrics

  # Grok Node metrics
  - job_name: 'grok-node'
    static_configs:
      - targets:
          - '10.44.0.1:11434'
        labels:
          service: 'ollama'
    metrics_path: /metrics

  # WireGuard exporter (custom)
  - job_name: 'wireguard'
    static_configs:
      - targets:
          - '10.44.0.1:9586'
          - '10.44.1.1:9586'
          - '10.44.2.1:9586'
        labels:
          service: 'wireguard'

  # Syncthing metrics
  - job_name: 'syncthing'
    static_configs:
      - targets:
          - '10.44.0.1:8384'
    metrics_path: /rest/system/metrics
    authorization:
      type: Bearer
      credentials_file: /etc/prometheus/syncthing_api_key

# Remote write to NATS (optional - for telemetry bridging)
# Uncomment to enable NATS telemetry bridge
# remote_write:
#   - url: http://localhost:9201/write
#     remote_timeout: 30s
#     queue_config:
#       capacity: 10000
#       max_shards: 10
#       max_samples_per_send: 5000
