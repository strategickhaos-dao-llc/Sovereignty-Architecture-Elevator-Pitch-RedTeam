# nats.conf â€” Sovereign Swarm v2.0
# NATS Server Configuration with JetStream RAFT Clustering
# Evolution #4: Full RAFT consensus + load balancing
#
# Strategickhaos DAO LLC / Valoryield Engine
# Author: Domenic Garza (Node 137)

# Server identity
server_name: ${NATS_SERVER_NAME:-swarm-node-0}

# Network binding
port: 4222
http_port: 8222

# Authentication
authorization {
    users: [
        {
            user: swarm
            password: $NATS_PASSWORD
            permissions: {
                publish: [">"]
                subscribe: [">"]
            }
        }
        {
            user: pelican
            password: $PELICAN_PASSWORD
            permissions: {
                publish: ["telemetry.>", "swarm.join.>"]
                subscribe: ["cmd.>", "audit.revoke.>"]
            }
        }
        {
            user: ally
            password: $ALLY_PASSWORD
            permissions: {
                publish: ["telemetry.ally.>"]
                subscribe: ["broadcast.>"]
            }
        }
    ]
}

# JetStream for persistent telemetry streams
jetstream {
    store_dir: /opt/sovereign-swarm/nats/jetstream
    max_mem: 1G
    max_file: 10G
}

# Cluster configuration for RAFT consensus (Evolution #4)
# Requires 3 nodes minimum for quorum
cluster {
    name: sovereign-swarm
    listen: 0.0.0.0:6222
    
    # Route connections to other nodes
    # Command-0 (rendezvous): 10.44.0.1
    # Fixed-1: 10.44.1.1
    # Mobile-2: 10.44.2.1
    routes: [
        nats-route://10.44.0.1:6222
        nats-route://10.44.1.1:6222
        nats-route://10.44.2.1:6222
    ]
    
    # Route authorization
    authorization {
        user: cluster
        password: $CLUSTER_PASSWORD
        timeout: 2
    }
}

# Leafnode configuration for edge nodes (Pelicans)
leafnodes {
    port: 7422
    
    authorization {
        user: leaf
        password: $LEAF_PASSWORD
        timeout: 1
    }
}

# Logging
debug: false
trace: false
logtime: true
log_file: /opt/sovereign-swarm/nats/nats.log
log_size_limit: 100MB
max_traced_msg_len: 1024

# Monitoring
http_base_path: /nats

# Connection limits
max_connections: 1000
max_subscriptions: 100000
max_payload: 1MB
max_pending: 64MB

# Ping/Pong for keepalive
ping_interval: 30s
ping_max: 3

# Write deadline for slow consumers
write_deadline: 10s

# TLS configuration (enable in production)
# tls {
#     cert_file: /etc/nats/certs/server.crt
#     key_file: /etc/nats/certs/server.key
#     ca_file: /etc/nats/certs/ca.crt
#     verify: true
#     timeout: 2
# }

# System account for internal messaging
system_account: SYS

accounts {
    SYS: {
        users: [
            {user: admin, password: $ADMIN_PASSWORD}
        ]
    }
    SWARM: {
        jetstream: enabled
        users: [
            {user: swarm, password: $SWARM_PASSWORD}
        ]
    }
}
