# Pong-001 Test Deployment
# Purpose: First workload for GKE cluster to validate:
#   - Pod scheduling
#   - Image pulls
#   - Authentication
#   - Cluster connectivity
#
# This is a simple test container that stays alive for debugging purposes.
# Replace with your actual application image for production use.
#
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pong-001
  namespace: default
  labels:
    app: pong-001
    component: swarm-test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pong-001
  template:
    metadata:
      labels:
        app: pong-001
    spec:
      containers:
        - name: pong
          # Using python:3.11-slim as a simple test container
          # Replace with your actual application image for production
          image: python:3.11-slim
          # Simple HTTP server for testing - exposes port 8000
          command:
            - python3
            - -c
            - |
              import http.server
              import socketserver
              import os

              PORT = 8000
              Handler = http.server.SimpleHTTPRequestHandler

              class HealthHandler(http.server.SimpleHTTPRequestHandler):
                  def do_GET(self):
                      if self.path == '/health' or self.path == '/':
                          self.send_response(200)
                          self.send_header('Content-type', 'text/plain')
                          self.end_headers()
                          self.wfile.write(b'Pong-001 alive')
                      else:
                          super().do_GET()

              with socketserver.TCPServer(("", PORT), HealthHandler) as httpd:
                  print(f"Serving at port {PORT}")
                  httpd.serve_forever()
          ports:
            - containerPort: 8000
              name: http
          env:
            - name: DISCORD_TOKEN
              valueFrom:
                secretKeyRef:
                  name: discord-token
                  key: token
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "100m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 5
            periodSeconds: 10
