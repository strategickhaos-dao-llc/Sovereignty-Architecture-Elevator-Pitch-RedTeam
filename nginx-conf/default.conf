# Nginx configuration for invite-only honeypot system

log_format honeypot_access '$remote_addr - $remote_user [$time_local] '
                           '"$request" $status $body_bytes_sent '
                           '"$http_referer" "$http_user_agent" '
                           'session="$cookie_session_id"';

server {
    listen 80;
    server_name _;
    
    # Enable access logging with custom format
    access_log /var/log/nginx/honeypot_access.log honeypot_access;
    error_log /var/log/nginx/honeypot_error.log warn;
    
    # Security headers
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer" always;
    
    root /usr/share/nginx/html;
    index index.html;
    
    # Health check endpoint (no auth required)
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
    
    # Main page - requires secret token in URL or basic auth
    location = / {
        # Optional: Require secret token parameter
        # if ($arg_token != "YOUR_SECRET_TOKEN") {
        #     return 403;
        # }
        try_files $uri $uri/ =404;
    }
    
    # Log access endpoint for JavaScript tracking
    location /log-access {
        # Accept POST requests for logging
        if ($request_method != POST) {
            return 405;
        }
        
        # Log the access
        access_log /var/log/nginx/honeypot_access.log honeypot_access;
        
        # Return success
        return 200 '{"status":"logged"}';
        add_header Content-Type application/json;
    }
    
    # Real lab download - heavily logged
    location /real-lab.zip {
        # Optional: Add basic auth here
        # auth_basic "Restricted Access";
        # auth_basic_user_file /etc/nginx/.htpasswd;
        
        # Force download
        add_header Content-Disposition "attachment; filename=real-lab.zip";
        
        # Log every download attempt
        access_log /var/log/nginx/honeypot_access.log honeypot_access;
        
        # TODO: Build the real lab package first using scripts/build-lab-packages.sh
        # The file will be placed at /usr/share/nginx/html/real-lab.zip by the build script
        # For now, returns 404 until packages are built
        try_files $uri =404;
    }
    
    # Honeypot lab download - also logged
    location /honeypot-lab.zip {
        # Force download
        add_header Content-Disposition "attachment; filename=honeypot-lab.zip";
        
        # Log every download attempt
        access_log /var/log/nginx/honeypot_access.log honeypot_access;
        
        # TODO: Build the honeypot lab package first using scripts/build-lab-packages.sh
        # The file will be placed at /usr/share/nginx/html/honeypot-lab.zip by the build script
        # For now, returns 404 until packages are built
        try_files $uri =404;
    }
    
    # Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}
