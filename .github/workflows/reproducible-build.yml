name: Reproducible Build + OpenTimestamps

on:
  push:
    branches: [main]
    tags: ['v*']
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write
  attestations: write

jobs:
  # Build with reproducible settings
  reproducible-build:
    name: Reproducible Build
    runs-on: ubuntu-latest
    outputs:
      contracts-hash: ${{ steps.hash.outputs.contracts }}
      legal-hash: ${{ steps.hash.outputs.legal }}
      full-hash: ${{ steps.hash.outputs.full }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: contracts/package-lock.json
      
      - name: Install contract dependencies
        run: |
          cd contracts
          npm ci --ignore-scripts
      
      - name: Compile contracts with deterministic output
        run: |
          cd contracts
          npx hardhat compile
        env:
          HARDHAT_COMPILE_DETERMINISTIC: true
      
      - name: Generate build manifest
        id: manifest
        run: |
          mkdir -p build-artifacts
          
          # Create comprehensive manifest
          cat > build-artifacts/BUILD_MANIFEST.json << EOF
          {
            "version": "1.0.0",
            "buildTime": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "gitCommit": "${{ github.sha }}",
            "gitRef": "${{ github.ref }}",
            "gitTag": "${{ github.ref_name }}",
            "runner": "${{ runner.os }}-${{ runner.arch }}",
            "nodeVersion": "$(node --version)",
            "npmVersion": "$(npm --version)",
            "hardhatVersion": "$(cd contracts && npx hardhat --version 2>/dev/null || echo 'unknown')"
          }
          EOF
          
          cat build-artifacts/BUILD_MANIFEST.json
      
      - name: Calculate deterministic hashes
        id: hash
        run: |
          # Hash contract source files
          CONTRACTS_HASH=$(find contracts/src -name "*.sol" -type f | sort | xargs sha256sum | sha256sum | cut -d' ' -f1)
          echo "contracts=${CONTRACTS_HASH}" >> $GITHUB_OUTPUT
          
          # Hash legal documents
          LEGAL_HASH=$(find legal/formation -name "*.md" -type f | sort | xargs sha256sum | sha256sum | cut -d' ' -f1)
          echo "legal=${LEGAL_HASH}" >> $GITHUB_OUTPUT
          
          # Hash entire reproducible build
          FULL_HASH=$(find contracts/src legal/formation -type f | sort | xargs sha256sum | sha256sum | cut -d' ' -f1)
          echo "full=${FULL_HASH}" >> $GITHUB_OUTPUT
          
          # Write hashes to file
          cat > build-artifacts/HASHES.txt << EOF
          # Strategickhaos DAO - Reproducible Build Hashes
          # Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          # Git Commit: ${{ github.sha }}
          
          contracts_source_sha256: ${CONTRACTS_HASH}
          legal_docs_sha256: ${LEGAL_HASH}
          full_build_sha256: ${FULL_HASH}
          EOF
          
          cat build-artifacts/HASHES.txt
      
      - name: Copy artifacts for timestamping
        run: |
          # Copy contract sources
          cp -r contracts/src build-artifacts/contracts/
          
          # Copy compiled artifacts (if they exist)
          if [ -d "contracts/artifacts" ]; then
            cp -r contracts/artifacts build-artifacts/compiled/
          fi
          
          # Copy legal documents
          cp -r legal/formation build-artifacts/legal/
          
          # Create archive
          tar -czvf strategickhaos-build-${{ github.sha }}.tar.gz build-artifacts/
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: reproducible-build-${{ github.sha }}
          path: |
            build-artifacts/
            strategickhaos-build-${{ github.sha }}.tar.gz
          retention-days: 90

  # OpenTimestamps attestation
  opentimestamps:
    name: OpenTimestamps Attestation
    runs-on: ubuntu-latest
    needs: reproducible-build
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: reproducible-build-${{ github.sha }}
          path: build-artifacts/
      
      - name: Install OpenTimestamps
        run: |
          pip install opentimestamps-client
      
      - name: Create timestamp proof
        run: |
          # Create a file with all the hashes to timestamp
          cat > hash-to-timestamp.txt << EOF
          Strategickhaos DAO - Canonical Build Attestation
          ================================================
          
          Build Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          Git Commit: ${{ github.sha }}
          Git Ref: ${{ github.ref }}
          
          Hashes:
          - Contracts Source: ${{ needs.reproducible-build.outputs.contracts-hash }}
          - Legal Documents: ${{ needs.reproducible-build.outputs.legal-hash }}
          - Full Build: ${{ needs.reproducible-build.outputs.full-hash }}
          
          This attestation proves that the code and legal documents existed
          at the time this timestamp was created. Verification can be done
          at: https://opentimestamps.org/
          EOF
          
          cat hash-to-timestamp.txt
          
          # Create OTS timestamp (will be pending until Bitcoin confirmation)
          ots stamp hash-to-timestamp.txt
          
          # Show the pending timestamp
          ots info hash-to-timestamp.txt.ots || echo "Timestamp created (pending confirmation)"
      
      - name: Upload timestamp proof
        uses: actions/upload-artifact@v4
        with:
          name: opentimestamps-${{ github.sha }}
          path: |
            hash-to-timestamp.txt
            hash-to-timestamp.txt.ots
          retention-days: 365

  # Create release attestation
  release-attestation:
    name: Release Attestation
    runs-on: ubuntu-latest
    needs: [reproducible-build, opentimestamps]
    if: github.event_name == 'release' || startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts/
      
      - name: Create release notes
        run: |
          cat > RELEASE_ATTESTATION.md << EOF
          # Release Attestation - ${{ github.ref_name }}
          
          ## Build Verification
          
          This release has been cryptographically attested using:
          
          1. **SHA-256 Hashes** - Deterministic build verification
          2. **OpenTimestamps** - Bitcoin blockchain timestamping
          3. **GitHub Attestations** - Sigstore-backed provenance
          
          ## Hashes
          
          \`\`\`
          Contracts Source: ${{ needs.reproducible-build.outputs.contracts-hash }}
          Legal Documents:  ${{ needs.reproducible-build.outputs.legal-hash }}
          Full Build:       ${{ needs.reproducible-build.outputs.full-hash }}
          \`\`\`
          
          ## Verification Steps
          
          1. Clone the repository at this tag:
             \`\`\`bash
             git clone --branch ${{ github.ref_name }} https://github.com/${{ github.repository }}
             \`\`\`
          
          2. Calculate hashes locally:
             \`\`\`bash
             find contracts/src -name "*.sol" -type f | sort | xargs sha256sum | sha256sum
             \`\`\`
          
          3. Verify OpenTimestamps proof:
             \`\`\`bash
             pip install opentimestamps-client
             ots verify hash-to-timestamp.txt.ots
             \`\`\`
          
          ## Trust Dashboard
          
          View real-time verification at: [Trust Dashboard](https://github.com/${{ github.repository }}/tree/main/trust-dashboard)
          
          ---
          
          *This attestation was automatically generated by the reproducible build pipeline.*
          EOF
          
          cat RELEASE_ATTESTATION.md
      
      - name: Upload release attestation
        uses: actions/upload-artifact@v4
        with:
          name: release-attestation-${{ github.ref_name }}
          path: RELEASE_ATTESTATION.md
          retention-days: 365

  # Notify on completion
  notify:
    name: Notify Completion
    runs-on: ubuntu-latest
    needs: [reproducible-build, opentimestamps]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## Reproducible Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | Hash |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Contracts | \`${{ needs.reproducible-build.outputs.contracts-hash }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Legal Docs | \`${{ needs.reproducible-build.outputs.legal-hash }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Full Build | \`${{ needs.reproducible-build.outputs.full-hash }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… OpenTimestamps proof created (pending Bitcoin confirmation)" >> $GITHUB_STEP_SUMMARY
