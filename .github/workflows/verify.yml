name: Integrity Verification

on:
  # Run daily at midnight UTC
  schedule:
    - cron: '0 0 * * *'
  
  # Run on pushes to main
  push:
    branches: [main]
  
  # Run on pull requests to main
  pull_request:
    branches: [main]
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose output'
        required: false
        default: 'false'
        type: boolean

env:
  REPORT_ARTIFACT_NAME: verification-report

jobs:
  verify:
    name: Verify Repository Integrity
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      actions: read
    
    outputs:
      verification_status: ${{ steps.verify.outputs.status }}
      verification_timestamp: ${{ steps.verify.outputs.timestamp }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for GPG verification
      
      - name: Setup verification environment
        run: |
          echo "Setting up verification environment..."
          
          # Ensure verify.sh is executable
          chmod +x verify.sh
          
          # Display environment info
          echo "Git version: $(git --version)"
          echo "Bash version: ${BASH_VERSION}"
          echo "SHA256sum available: $(command -v sha256sum && echo 'yes' || echo 'no')"
      
      - name: Run integrity verification
        id: verify
        run: |
          echo "Running integrity verification..."
          
          # Set timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          
          # Run verification in CI mode
          VERBOSE_FLAG=""
          if [[ "${{ github.event.inputs.verbose }}" == "true" ]]; then
            VERBOSE_FLAG="--verbose"
          fi
          
          if ./verify.sh --ci $VERBOSE_FLAG; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "✅ FULL CORPUS VERIFIED"
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "❌ VERIFICATION FAILED"
            exit 1
          fi
      
      - name: Generate signed verification report
        if: always()
        run: |
          # Create detailed report
          REPORT_FILE="verification_report_signed.txt"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          cat > "$REPORT_FILE" << EOF
          ===============================================
          SOVEREIGNTY ARCHITECTURE VERIFICATION REPORT
          ===============================================
          
          Workflow Run ID: ${{ github.run_id }}
          Workflow Run Number: ${{ github.run_number }}
          Timestamp: $TIMESTAMP
          
          Repository: ${{ github.repository }}
          Commit SHA: ${{ github.sha }}
          Ref: ${{ github.ref }}
          Actor: ${{ github.actor }}
          Event: ${{ github.event_name }}
          
          -----------------------------------------------
          VERIFICATION STATUS: ${{ steps.verify.outputs.status || 'unknown' }}
          -----------------------------------------------
          
          Files Verified:
          $(cat verification_report.txt 2>/dev/null || echo "Report not available")
          
          ===============================================
          Signature Information
          ===============================================
          
          This report was generated by GitHub Actions.
          Workflow SHA: ${{ github.sha }}
          Runner: ${{ runner.os }} / ${{ runner.arch }}
          
          To verify this report:
          1. Check the workflow run at:
             ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          2. Verify the commit signature if GPG-signed
          3. Compare artifact checksums
          
          ===============================================
          END OF REPORT
          ===============================================
          EOF
          
          # Calculate SHA256 of the report
          sha256sum "$REPORT_FILE" > "${REPORT_FILE}.sha256"
          
          echo "Report generated: $REPORT_FILE"
      
      - name: Upload verification report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.REPORT_ARTIFACT_NAME }}-${{ github.run_number }}
          path: |
            verification_report.txt
            verification_report_signed.txt
            verification_report_signed.txt.sha256
            reproducibility_manifest.yml
          retention-days: 90
      
      - name: Post verification summary
        if: always()
        run: |
          echo "## Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.verify.outputs.status }}" == "success" ]]; then
            echo "✅ **Status:** FULL CORPUS VERIFIED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Status:** VERIFICATION FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** ${{ steps.verify.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Verification report uploaded as artifact" >> $GITHUB_STEP_SUMMARY
          echo "- Report includes SHA256 checksum for integrity verification" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify on Failure
    needs: verify
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: Create failure notification
        run: |
          echo "::warning::Integrity verification failed!"
          echo "Verification failed at $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "Check the verification report artifact for details."
          
          # This step can be extended to:
          # - Send Discord notification
          # - Create GitHub issue
          # - Send email alert
          # depending on organization requirements
