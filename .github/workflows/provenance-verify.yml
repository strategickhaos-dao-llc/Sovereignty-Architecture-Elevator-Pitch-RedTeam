name: SwarmGate Provenance Verify

on:
  push:
    branches: [main]
    paths:
      - 'contracts/**'
      - 'swarmgate/status.yaml'
  pull_request:
    branches: [main]
    paths:
      - 'contracts/**'
      - 'swarmgate/status.yaml'
  workflow_dispatch:
  schedule:
    # Run weekly on Sundays at midnight UTC
    - cron: '0 0 * * 0'

jobs:
  verify-checksums:
    name: Verify Contract Checksums
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Compute current checksums
        id: compute
        run: |
          echo "Computing checksums for contract files..."
          
          # Create checksums file
          echo "# Computed checksums - $(date -u +%Y-%m-%dT%H:%M:%SZ)" > computed_checksums.txt
          
          # Find all Solidity files and compute checksums
          find contracts -name "*.sol" -type f | sort | while read file; do
            checksum=$(sha256sum "$file" | cut -d' ' -f1)
            echo "$file: sha256:$checksum" >> computed_checksums.txt
            echo "$file: $checksum"
          done
          
          # Get main contract checksum
          if [ -f "contracts/SwarmGate.sol" ]; then
            main_checksum=$(sha256sum contracts/SwarmGate.sol | cut -d' ' -f1)
            echo "swarmgate_checksum=$main_checksum" >> $GITHUB_OUTPUT
            echo "Main contract checksum: $main_checksum"
          fi

      - name: Read status.yaml checksums
        id: status
        run: |
          if [ -f "swarmgate/status.yaml" ]; then
            recorded_checksum=$(yq '.artifacts.contracts.checksums.swarmgate_sol' swarmgate/status.yaml 2>/dev/null || echo "not-found")
            echo "recorded_checksum=$recorded_checksum" >> $GITHUB_OUTPUT
            echo "Recorded checksum in status.yaml: $recorded_checksum"
          else
            echo "recorded_checksum=not-found" >> $GITHUB_OUTPUT
            echo "⚠️ swarmgate/status.yaml not found"
          fi

      - name: Compare checksums
        run: |
          computed="${{ steps.compute.outputs.swarmgate_checksum }}"
          recorded="${{ steps.status.outputs.recorded_checksum }}"
          
          echo "================================================"
          echo "PROVENANCE VERIFICATION REPORT"
          echo "================================================"
          echo "Computed checksum: $computed"
          echo "Recorded checksum: $recorded"
          echo "================================================"
          
          if [ "$recorded" == "placeholder-update-on-build" ]; then
            echo "ℹ️ Status YAML contains placeholder checksum"
            echo "   Update swarmgate/status.yaml with computed checksum for production"
            echo "   Computed: sha256:$computed"
          elif [ "$recorded" == "not-found" ]; then
            echo "⚠️ No recorded checksum found in status.yaml"
          elif [ "sha256:$computed" == "$recorded" ]; then
            echo "✅ Checksums match - provenance verified"
          else
            echo "❌ CHECKSUM MISMATCH - Possible tampering detected!"
            echo "   This could indicate:"
            echo "   - Contract source was modified without updating status.yaml"
            echo "   - Status.yaml was updated incorrectly"
            echo "   - Potential unauthorized modification"
            exit 1
          fi

      - name: Generate provenance report
        run: |
          cat > provenance_report.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "ref": "${{ github.ref }}",
            "actor": "${{ github.actor }}",
            "computed_checksum": "${{ steps.compute.outputs.swarmgate_checksum }}",
            "recorded_checksum": "${{ steps.status.outputs.recorded_checksum }}",
            "verification_status": "$([ "${{ steps.compute.outputs.swarmgate_checksum }}" == "$(echo '${{ steps.status.outputs.recorded_checksum }}' | sed 's/sha256://')" ] && echo "verified" || echo "pending")"
          }
          EOF
          
          cat provenance_report.json

      - name: Upload provenance report
        uses: actions/upload-artifact@v4
        with:
          name: provenance-report
          path: |
            provenance_report.json
            computed_checksums.txt
          retention-days: 90

  verify-signatures:
    name: Verify Commit Signatures
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 10

      - name: Check commit signatures
        run: |
          echo "Checking commit signatures..."
          
          # Get recent commits that modified contracts
          git log --oneline -10 -- contracts/ swarmgate/ | while read line; do
            commit=$(echo "$line" | cut -d' ' -f1)
            sig_status=$(git verify-commit "$commit" 2>&1 || echo "unsigned")
            
            if echo "$sig_status" | grep -q "Good signature"; then
              echo "✅ $line - Signed"
            else
              echo "⚠️ $line - Unsigned or verification failed"
            fi
          done
          
          echo ""
          echo "Note: Unsigned commits may be acceptable during development."
          echo "Production deployments should require signed commits."

  notify:
    name: Notify Verification Status
    runs-on: ubuntu-latest
    needs: [verify-checksums, verify-signatures]
    if: always()
    steps:
      - name: Notify Discord
        env:
          EVENTS_HMAC_KEY: ${{ secrets.EVENTS_HMAC_KEY }}
          EVENTS_URL: ${{ secrets.EVENTS_URL || 'https://events.strategickhaos.com/event' }}
        run: |
          if [ -z "$EVENTS_HMAC_KEY" ]; then
            echo "EVENTS_HMAC_KEY not configured, skipping notification"
            exit 0
          fi
          
          status="success"
          if [ "${{ needs.verify-checksums.result }}" != "success" ]; then
            status="failure"
          fi
          
          payload=$(jq -n \
            --arg repo "${{ github.repository }}" \
            --arg sha "${{ github.sha }}" \
            --arg status "$status" \
            --arg workflow "SwarmGate Provenance Verify" \
            '{service:"provenance", repo:$repo, sha:$sha, status:$status, workflow:$workflow, timestamp:now}')
          
          sig=$(printf '%s' "$payload" | openssl dgst -sha256 -hmac "$EVENTS_HMAC_KEY" -binary | xxd -p -c 256)
          
          curl -sS -X POST "$EVENTS_URL" \
            -H "Content-Type: application/json" \
            -H "X-Sig: $sig" \
            -d "$payload" || true
