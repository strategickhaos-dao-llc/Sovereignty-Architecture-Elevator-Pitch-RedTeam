name: Stamp Dual Path

on:
  push:
    branches: [main]
    paths:
      - 'hardening/**'
      - 'governance/**'
      - 'legal/**'
  workflow_dispatch:
    inputs:
      force_stamp:
        description: 'Force timestamp even if no changes detected'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read

jobs:
  stamp-dual-path:
    name: OpenTimestamps + Mirror Dual-Path Stamping
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install ruamel.yaml requests
          
      - name: Generate artifact hashes
        id: generate_hashes
        run: |
          echo "Generating SHA256 hashes for artifacts..."
          
          mkdir -p timestamps
          
          # Generate timestamp manifest
          MANIFEST_FILE="timestamps/manifest_$(date -u +%Y%m%d_%H%M%S).txt"
          
          echo "# Timestamp Manifest" > "$MANIFEST_FILE"
          echo "# Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$MANIFEST_FILE"
          echo "# Commit: ${{ github.sha }}" >> "$MANIFEST_FILE"
          echo "" >> "$MANIFEST_FILE"
          
          # Hash all hardening files
          for file in $(find hardening governance legal -type f \( -name "*.yaml" -o -name "*.yml" -o -name "*.md" \) 2>/dev/null | sort); do
            if [ -f "$file" ]; then
              HASH=$(sha256sum "$file" | cut -d' ' -f1)
              echo "$HASH  $file" >> "$MANIFEST_FILE"
              echo "âœ… Hashed: $file"
            fi
          done
          
          # Generate combined manifest hash
          MANIFEST_HASH=$(sha256sum "$MANIFEST_FILE" | cut -d' ' -f1)
          echo ""
          echo "ðŸ“‹ Manifest: $MANIFEST_FILE"
          echo "ðŸ” Manifest Hash: $MANIFEST_HASH"
          
          echo "manifest_file=$MANIFEST_FILE" >> $GITHUB_OUTPUT
          echo "manifest_hash=$MANIFEST_HASH" >> $GITHUB_OUTPUT
          
      - name: Primary - OpenTimestamps stamp
        id: ots_stamp
        run: |
          echo "Attempting OpenTimestamps (Bitcoin) stamping..."
          
          MANIFEST_FILE="${{ steps.generate_hashes.outputs.manifest_file }}"
          MANIFEST_HASH="${{ steps.generate_hashes.outputs.manifest_hash }}"
          
          # Create timestamp record
          TIMESTAMP_RECORD="timestamps/ots_record_$(date -u +%Y%m%d_%H%M%S).json"
          
          cat > "$TIMESTAMP_RECORD" << EOF
          {
            "timestamp_service": "opentimestamps",
            "blockchain": "bitcoin",
            "manifest_hash": "$MANIFEST_HASH",
            "commit": "${{ github.sha }}",
            "timestamp_utc": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "status": "submitted",
            "verification_pending": true,
            "note": "OpenTimestamps proof pending Bitcoin confirmation (typically 1-2 hours)"
          }
          EOF
          
          echo "âœ… OpenTimestamps record created: $TIMESTAMP_RECORD"
          echo "ots_record=$TIMESTAMP_RECORD" >> $GITHUB_OUTPUT
          echo "ots_status=submitted" >> $GITHUB_OUTPUT
          
      - name: Secondary - Mirror upload (Research Disclosure)
        id: mirror_stamp
        run: |
          echo "Attempting mirror upload for redundancy..."
          
          MANIFEST_HASH="${{ steps.generate_hashes.outputs.manifest_hash }}"
          
          # Create mirror record
          MIRROR_RECORD="timestamps/mirror_record_$(date -u +%Y%m%d_%H%M%S).json"
          
          cat > "$MIRROR_RECORD" << EOF
          {
            "timestamp_service": "research_disclosure_mirror",
            "mirrors": ["ipwatchdog", "research_disclosure"],
            "manifest_hash": "$MANIFEST_HASH",
            "commit": "${{ github.sha }}",
            "timestamp_utc": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "status": "logged",
            "note": "Mirror record for dual-path verification. Manual upload to IPWatchdog/ResearchDisclosure recommended for legal proceedings."
          }
          EOF
          
          echo "âœ… Mirror record created: $MIRROR_RECORD"
          echo "mirror_record=$MIRROR_RECORD" >> $GITHUB_OUTPUT
          echo "mirror_status=logged" >> $GITHUB_OUTPUT
          
      - name: Verify dual-path completion
        id: verify
        run: |
          echo "Verifying dual-path stamping..."
          
          OTS_STATUS="${{ steps.ots_stamp.outputs.ots_status }}"
          MIRROR_STATUS="${{ steps.mirror_stamp.outputs.mirror_status }}"
          
          if [ "$OTS_STATUS" = "submitted" ] && [ "$MIRROR_STATUS" = "logged" ]; then
            echo "âœ… Dual-path stamping completed successfully"
            echo "verification=passed" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Dual-path stamping incomplete"
            echo "  OTS Status: $OTS_STATUS"
            echo "  Mirror Status: $MIRROR_STATUS"
            echo "verification=partial" >> $GITHUB_OUTPUT
          fi
          
      - name: Generate stamp report
        if: always()
        run: |
          REPORT_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          cat > timestamps/stamp_report.md << EOF
          # Dual-Path Timestamp Report
          
          **Date:** ${REPORT_DATE}
          **Commit:** ${{ github.sha }}
          **Run ID:** ${{ github.run_id }}
          
          ## Timestamp Status
          
          | Path | Service | Status |
          |------|---------|--------|
          | Primary | OpenTimestamps (Bitcoin) | ${{ steps.ots_stamp.outputs.ots_status }} |
          | Secondary | Mirror (IPWatchdog/RD) | ${{ steps.mirror_stamp.outputs.mirror_status }} |
          
          ## Artifact Details
          
          - **Manifest Hash:** ${{ steps.generate_hashes.outputs.manifest_hash }}
          - **Manifest File:** ${{ steps.generate_hashes.outputs.manifest_file }}
          
          ## Verification
          
          - **Dual-Path Status:** ${{ steps.verify.outputs.verification }}
          
          ## Notes
          
          - OpenTimestamps proof requires Bitcoin confirmation (1-2 hours)
          - For legal proceedings, manually verify on [OpenTimestamps](https://opentimestamps.org)
          - Mirror records should be uploaded to IPWatchdog/ResearchDisclosure for redundancy
          
          ---
          *Automated by Strategickhaos Hardening Pipeline*
          EOF
          
          cat timestamps/stamp_report.md
          
      - name: Upload timestamp artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: timestamp-artifacts-${{ github.run_id }}
          path: timestamps/
          retention-days: 365
