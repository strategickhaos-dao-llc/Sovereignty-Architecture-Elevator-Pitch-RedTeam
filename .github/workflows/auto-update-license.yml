name: Auto-Update License

on:
  push:
    branches:
      - main
    paths:
      - 'LICENSE'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update_license:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ”„ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“„ Extract license information
        id: license_info
        run: |
          # Extract copyright year and owner from LICENSE file
          if [[ -f "LICENSE" ]]; then
            COPYRIGHT_LINE=$(grep -i "Copyright" LICENSE | head -1)
            echo "copyright_line=${COPYRIGHT_LINE}" >> $GITHUB_OUTPUT
            
            # Extract year
            YEAR=$(echo "$COPYRIGHT_LINE" | grep -oP '20\d{2}' | head -1)
            echo "year=${YEAR}" >> $GITHUB_OUTPUT
            
            # Extract owner
            OWNER=$(echo "$COPYRIGHT_LINE" | sed -E 's/.*Copyright \(c\) [0-9]+ //' | sed 's/^ *//;s/ *$//')
            echo "owner=${OWNER}" >> $GITHUB_OUTPUT
            
            echo "âœ… License info extracted:"
            echo "  Year: ${YEAR}"
            echo "  Owner: ${OWNER}"
          else
            echo "âŒ LICENSE file not found"
            exit 1
          fi

      - name: ðŸ” Update license references in markdown files
        run: |
          echo "Updating license references in markdown files..."
          
          # Get license info
          LICENSE_TEXT=$(cat LICENSE)
          COPYRIGHT_YEAR="${{ steps.license_info.outputs.year }}"
          COPYRIGHT_OWNER="${{ steps.license_info.outputs.owner }}"
          
          # Find all markdown files that reference LICENSE (more specific pattern)
          MD_FILES=$(grep -l "\[LICENSE\]\|see.*LICENSE.*file\|MIT License" *.md 2>/dev/null || true)
          
          if [[ -n "$MD_FILES" ]]; then
            echo "ðŸ“ Found markdown files with license references:"
            echo "$MD_FILES"
            
            # Ensure license information is current
            for file in $MD_FILES; do
              if grep -q "MIT License" "$file"; then
                echo "  âœ“ Verified license reference in $file"
              fi
            done
          else
            echo "â„¹ï¸ No markdown files with explicit license references found"
          fi
          
          echo "âœ… License reference verification complete"

      - name: ðŸ“‹ Update README with license badge
        run: |
          # Check if README.md exists and has license section
          if [[ -f "README.md" ]]; then
            if ! grep -q "MIT License" README.md; then
              echo "â„¹ï¸ README.md exists but license information might need updating"
            else
              echo "âœ… README.md already contains MIT License reference"
            fi
          fi

      - name: ðŸ”§ Check for changes
        id: check_changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          
          # Check if there are any changes
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Changes detected"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "âœ… No changes needed - license information is current"
          fi

      - name: ðŸ’¾ Commit changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git add .
          git commit -m "Auto-update license information [skip ci]

          - Updated license references in markdown files
          - Verified copyright year: ${{ steps.license_info.outputs.year }}
          - Verified copyright owner: ${{ steps.license_info.outputs.owner }}
          
          This commit was automatically generated by the Auto-Update License workflow."

      - name: ðŸš€ Push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git push
          echo "âœ… Changes pushed successfully"

      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "## License Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Copyright Year:** ${{ steps.license_info.outputs.year }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Copyright Owner:** ${{ steps.license_info.outputs.owner }}" >> $GITHUB_STEP_SUMMARY
          echo "- **License Type:** MIT License" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes Made:** ${{ steps.check_changes.outputs.changes }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.check_changes.outputs.changes }}" == "true" ]]; then
            echo "âœ… License information updated successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… License information is current - no updates needed" >> $GITHUB_STEP_SUMMARY
          fi

  notify:
    needs: update_license
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“¡ Notify completion
        run: |
          echo "ðŸŽ¯ License update workflow completed"
          echo "Status: ${{ needs.update_license.result }}"
          
          # Future: Could integrate with Discord/Slack notifications
          # Future: Could update Obsidian notes via API
          # Future: Could update JetBrains IDE settings
