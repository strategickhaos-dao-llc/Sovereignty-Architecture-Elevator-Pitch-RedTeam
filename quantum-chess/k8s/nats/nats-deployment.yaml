# NATS JetStream Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: quantum-chess
  labels:
    app: quantum-chess
    component: entanglement
---
# NATS ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: nats-config
  namespace: quantum-chess
  labels:
    app: quantum-chess
    component: nats
data:
  nats.conf: |
    # NATS Server Configuration for Quantum Chess
    # Quantum Entanglement Layer - Instant Messaging Between Dimensions
    
    server_name: quantum-chess-nats
    
    # Client connections
    port: 4222
    
    # HTTP monitoring
    http_port: 8222
    
    # Cluster configuration
    cluster {
      name: quantum-chess-cluster
      port: 6222
      routes [
        nats://nats-0.nats-headless.quantum-chess.svc.cluster.local:6222
        nats://nats-1.nats-headless.quantum-chess.svc.cluster.local:6222
        nats://nats-2.nats-headless.quantum-chess.svc.cluster.local:6222
      ]
    }
    
    # JetStream configuration (quantum-like persistence)
    jetstream {
      store_dir: /data/jetstream
      max_mem: 1G
      max_file: 10G
    }
    
    # Logging
    debug: false
    trace: false
    logtime: true
    
    # Authorization
    authorization {
      default_permissions {
        publish: ["red.>", "blue.>", "quantum.>", "legion.>"]
        subscribe: ["red.>", "blue.>", "quantum.>", "legion.>"]
      }
    }
---
# NATS Headless Service (for StatefulSet DNS)
apiVersion: v1
kind: Service
metadata:
  name: nats-headless
  namespace: quantum-chess
  labels:
    app: quantum-chess
    component: nats
spec:
  clusterIP: None
  ports:
    - name: client
      port: 4222
      targetPort: 4222
    - name: cluster
      port: 6222
      targetPort: 6222
    - name: monitor
      port: 8222
      targetPort: 8222
  selector:
    app: quantum-chess
    component: nats
---
# NATS Client Service
apiVersion: v1
kind: Service
metadata:
  name: nats
  namespace: quantum-chess
  labels:
    app: quantum-chess
    component: nats
spec:
  type: ClusterIP
  ports:
    - name: client
      port: 4222
      targetPort: 4222
    - name: monitor
      port: 8222
      targetPort: 8222
  selector:
    app: quantum-chess
    component: nats
---
# NATS StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: nats
  namespace: quantum-chess
  labels:
    app: quantum-chess
    component: nats
spec:
  serviceName: nats-headless
  replicas: 3
  selector:
    matchLabels:
      app: quantum-chess
      component: nats
  template:
    metadata:
      labels:
        app: quantum-chess
        component: nats
    spec:
      containers:
        - name: nats
          image: nats:2.10-alpine
          args:
            - "-c"
            - "/etc/nats/nats.conf"
          ports:
            - name: client
              containerPort: 4222
            - name: cluster
              containerPort: 6222
            - name: monitor
              containerPort: 8222
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          volumeMounts:
            - name: config
              mountPath: /etc/nats
            - name: data
              mountPath: /data
          livenessProbe:
            httpGet:
              path: /
              port: 8222
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /
              port: 8222
            initialDelaySeconds: 5
            periodSeconds: 5
      volumes:
        - name: config
          configMap:
            name: nats-config
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 10Gi
---
# NATS JetStream Streams Configuration Job
apiVersion: batch/v1
kind: Job
metadata:
  name: nats-streams-setup
  namespace: quantum-chess
  labels:
    app: quantum-chess
    component: nats-setup
spec:
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-nats
          image: busybox:1.36
          command: ['sh', '-c', 'until nc -z nats 4222; do echo waiting for nats; sleep 2; done']
      containers:
        - name: setup
          image: natsio/nats-box:0.14
          command:
            - /bin/sh
            - -c
            - |
              # Create Red Team Moves Stream
              nats stream add red-team-moves \
                --subjects "red.>" \
                --retention limits \
                --max-msgs 1000000 \
                --max-age 24h \
                --storage file \
                --replicas 3 \
                --server nats://nats:4222 || true
              
              # Create Blue Team Moves Stream
              nats stream add blue-team-moves \
                --subjects "blue.>" \
                --retention limits \
                --max-msgs 1000000 \
                --max-age 24h \
                --storage file \
                --replicas 3 \
                --server nats://nats:4222 || true
              
              # Create Quantum Sync Stream
              nats stream add quantum-sync \
                --subjects "quantum.>" \
                --retention limits \
                --max-msgs 1000000 \
                --max-age 24h \
                --storage file \
                --replicas 3 \
                --server nats://nats:4222 || true
              
              # Create Legion Analysis Stream
              nats stream add legion-analysis \
                --subjects "legion.>" \
                --retention limits \
                --max-msgs 1000000 \
                --max-age 24h \
                --storage file \
                --replicas 3 \
                --server nats://nats:4222 || true
              
              echo "âœ… NATS JetStream streams configured for Quantum Chess!"
